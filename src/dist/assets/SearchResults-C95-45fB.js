import{_ as W,B as nt,r as P,l as x,g as X,c as r,b as i,d as t,n as N,t as v,h as S,e as z,w as B,f as Y,p as Z,z as J,k as E,Q as lt,R as Q,Y as it,q as ut,o as rt,D as ct,a as dt,F as A,i as F,j as G}from"./index-CQU0DmQk.js";import{g as mt,f as vt,P as pt}from"./PostCard-AwN3vA5N.js";const gt={class:"comment-main"},ft={class:"vote-container"},ht={class:"vote-score"},kt={class:"comment-content"},wt={class:"comment-header"},yt={class:"comment-header-left"},It=["src","alt"],Pt={class:"comment-metadata"},_t={class:"comment-time"},Ct={class:"comment-body"},$t=["innerHTML"],St={__name:"CommentCard",props:{comment:{type:Object,required:!0},opinion:{type:Object,default:()=>({opinionStatus:"NIL"})},user:{type:Object,default:()=>({userId:null,nickname:"未知用户"})},post:{type:Object,default:()=>({id:null,spaceName:"未知空间",subject:"未知帖子"})},compact:{type:Boolean,default:!1}},emits:["update:comment","update:opinion"],setup(w,{emit:q}){const c=w;nt();const l=q,m=P({...c.comment}),d=P({...c.opinion}),O=x(()=>{var u,o;return((u=m.value)==null?void 0:u.positiveCount)-((o=m.value)==null?void 0:o.negativeCount)}),R=x(()=>mt(c.user)),V=x(()=>{var u,o;return`/r/${((u=c.post)==null?void 0:u.spaceId)||""}/post/${((o=c.post)==null?void 0:o.id)||""}`}),H=x(()=>{var u;return{voted:((u=d.value)==null?void 0:u.opinionStatus)==="POSITIVE",upvote:!0}}),j=x(()=>{var u;return{voted:((u=d.value)==null?void 0:u.opinionStatus)==="NEGATIVE",downvote:!0}}),a=async u=>{var p,C,b;u.stopPropagation();const o=(p=d.value)==null?void 0:p.opinionStatus;o==="NEGATIVE"?(m.value.positiveCount++,m.value.negativeCount--):o!=="POSITIVE"&&m.value.positiveCount++,d.value={...d.value,opinionStatus:"POSITIVE",updatedAt:new Date().toISOString()};try{const I={commentId:c.comment.id,spaceId:(C=c.post)==null?void 0:C.spaceId,userId:(b=c.user)==null?void 0:b.userId,isPositive:!0};await E.post("/opinion/comment",I),l("update:comment",m.value),l("update:opinion",d.value)}catch{m.value={...c.comment},d.value={...c.opinion}}},y=async u=>{var p,C,b;u.stopPropagation();const o=(p=d.value)==null?void 0:p.opinionStatus;o==="POSITIVE"?(m.value.positiveCount--,m.value.negativeCount++):o!=="NEGATIVE"&&m.value.negativeCount++,d.value={...d.value,opinionStatus:"NEGATIVE",updatedAt:new Date().toISOString()};try{const I={commentId:c.comment.id,spaceId:(C=c.post)==null?void 0:C.spaceId,userId:(b=c.user)==null?void 0:b.userId,isPositive:!1};await E.post("/opinion/comment",I),console.log("提交成功:",I),l("update:comment",m.value),l("update:opinion",d.value)}catch(I){console.error("提交失败:",I),m.value={...c.comment},d.value={...c.opinion}}},_=u=>{if(!u)return"";const o=new Date(u);return Math.abs(new Date-o)/36e5<24?lt(o,{addSuffix:!0,locale:Q}):it(o,"yyyy年MM月dd日 HH:mm",{locale:Q})};return(u,o)=>{var C,b,I,L;const p=X("router-link");return i(),r("article",{class:N(["comment-card",{compact:w.compact}])},[t("div",gt,[t("div",ft,[t("button",{class:N(H.value),onClick:a,"aria-label":"Upvote"},o[3]||(o[3]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("polyline",{points:"18 15 12 9 6 15"})],-1)]),2),t("div",ht,v(O.value),1),t("button",{class:N(j.value),onClick:y,"aria-label":"Downvote"},o[4]||(o[4]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("polyline",{points:"6 9 12 15 18 9"})],-1)]),2)]),t("div",kt,[t("div",wt,[t("div",yt,[(C=w.user)!=null&&C.avatar?(i(),r("img",{key:0,src:w.user.avatar,alt:w.user.nickname,class:"user-avatar"},null,8,It)):S("",!0),z(p,{to:R.value,class:"author-link",onClick:o[0]||(o[0]=J(()=>{},["stop"]))},{default:B(()=>{var T;return[Y(v(Z(vt)((T=w.user)==null?void 0:T.nickname)),1)]}),_:1},8,["to"]),t("span",Pt,[o[5]||(o[5]=t("span",{class:"metadata-divider"},"评论于",-1)),z(p,{to:`/r/${((b=w.post)==null?void 0:b.spaceId)||""}`,class:"space-link",onClick:o[1]||(o[1]=J(()=>{},["stop"]))},{default:B(()=>{var T;return[Y(" r/"+v(((T=w.post)==null?void 0:T.spaceName)||"未知空间"),1)]}),_:1},8,["to"]),o[6]||(o[6]=t("span",{class:"metadata-divider"},"中的",-1)),z(p,{to:V.value,class:"post-link",onClick:o[2]||(o[2]=J(()=>{},["stop"]))},{default:B(()=>{var T;return[Y(v(((T=w.post)==null?void 0:T.subject)||"未知帖子"),1)]}),_:1},8,["to"]),t("span",_t,v(_((I=w.comment)==null?void 0:I.createdAt)),1)])])]),t("div",Ct,[t("p",{innerHTML:(L=w.comment)==null?void 0:L.content},null,8,$t)])])])],2)}}},bt=W(St,[["__scopeId","data-v-f78357e5"]]),Tt={class:"search-results"},Et={class:"search-header"},qt={class:"search-title"},Mt={class:"results-count"},Ut={class:"filter-tabs"},Nt={key:0,class:"loading-container"},Ot={key:0,class:"results-section"},Rt={class:"users-grid"},Vt=["src","alt"],Ht={class:"user-info"},jt={class:"username"},Dt={class:"nickname"},Lt={key:1,class:"results-section"},xt={class:"communities-grid"},At={class:"community-icon"},Bt=["src","alt"],Ft={class:"community-info"},Gt={class:"community-name"},zt={class:"community-description"},Yt={key:2,class:"results-section"},Jt={class:"posts-grid"},Kt={key:0,class:"infinite-loading-indicator"},Qt={key:1,class:"end-indicator"},Wt={key:3,class:"results-section"},Xt={class:"comments-grid"},Zt={key:0,class:"infinite-loading-indicator"},te={key:1,class:"end-indicator"},ee={key:4,class:"no-results"},se={__name:"SearchResults",setup(w){const q=ct(),c=P({data:{data:[],currentPage:0,totalPage:1},message:"",success:!1}),l=P("all"),m=P(!1),d=P(!1),O=P(!1),R=P(!0),V=P(!0);let H=null,j=null;const a=P({users:{data:{data:[{id:"",name:"",nickname:""}],currentPage:0,totalPage:1},message:"",success:!1},communities:{data:{data:[{id:"",name:"",description:""}],currentPage:0,totalPage:1},message:"",success:!1},posts:{data:{data:[],currentPage:0,totalPage:1},message:"",success:!1},comments:{data:{data:[],currentPage:0,totalPage:1},message:"",success:!1}}),y=P([]),_=P([]),u=async n=>{try{return(await Promise.all(n.map(k=>E.get(`/post/info?postId=${k}`)))).map(k=>k.data)}catch{return[]}},o=async n=>{try{return(await E.get(`/comment/search?ids=${n}`)).data||[]}catch{return[]}},p=async(n,e=0)=>{m.value=!0;try{const k=await E.get(`/search/user?query=${n}`);if(a.value.users=k.data,k.data.data.length>0){const D=k.data.data.map(h=>h.id).join(","),M=await E.get(`/user/avatars?userId=${D}`);a.value.users.data=k.data.data.map(h=>{var g;return{...h,avatar:((g=M.data.find(U=>U.userId==h.id))==null?void 0:g.avatar)||""}})}const s=await E.get(`/search/space?query=${n}`);if(a.value.communities=s.data,s.data.data.length>0){const D=s.data.data.map(h=>h.id).join(","),M=await E.get(`/space/avatars?ids=${D}`);a.value.communities.data=s.data.data.map(h=>{var g;return{...h,avatar:((g=M.data.find(U=>U.name===h.name))==null?void 0:g.avatar)||""}})}const $=await E.get(`/search/post?query=${n}&page=${e}`);if(a.value.posts=$.data,$.data.data.length>0){const D=$.data.data.map(h=>h.id),M=await u(D);e===0?y.value=M:y.value=[...y.value,...M]}const f=await E.get(`/search/comment?query=${n}&page=${e}`);if(a.value.comments=f.data,f.data.data.length>0){const D=f.data.data.map(g=>g.id),M=await o(D),h=f.data.data.map(g=>{const U=M.find(ot=>ot.comment.id===g.id);return U?{...U,comment:{...U.comment,content:g.content},post:{...U.post,spaceId:g.spaceId,id:g.postId}}:{comment:g,opinion:{opinionStatus:"NIL"},user:null,post:{id:g.postId,spaceId:g.spaceId}}});e===0?_.value=h:_.value=[..._.value,...h]}R.value=a.value.posts.data.currentPage<a.value.posts.data.totalPage-1,V.value=a.value.comments.data.currentPage<a.value.comments.data.totalPage-1,c.value.success=!0}catch{c.value.message="搜索失败"}finally{m.value=!1}},C=async()=>{if(!(d.value||!R.value)){d.value=!0;try{const n=a.value.posts.data.currentPage+1;await p(q.query.q,n)}catch{}finally{d.value=!1}}},b=async()=>{if(!(O.value||!V.value)){O.value=!0;try{const n=a.value.comments.data.currentPage+1;await p(q.query.q,n)}catch{}finally{O.value=!1}}},I=()=>{if(d.value&&O.value||!R.value&&!V.value)return;const n=window.scrollY||document.documentElement.scrollTop,e=window.innerHeight;document.documentElement.scrollHeight-n-e<200&&(j&&clearTimeout(j),j=setTimeout(()=>{l.value==="comments"?b():C()},100))},L=()=>{H||(H=requestAnimationFrame(()=>{I(),H=null}))};ut(()=>q.query.q,n=>{n?p(n,0):(a.value={users:{data:{data:[],currentPage:0,totalPage:1},message:"",success:!1},communities:{data:{data:[],currentPage:0,totalPage:1},message:"",success:!1},posts:{data:{data:[],currentPage:0,totalPage:1},message:"",success:!1},comments:{data:{data:[],currentPage:0,totalPage:1},message:"",success:!1}},y.value=[],_.value=[])}),rt(()=>{q.query.q&&p(q.query.q,0),window.addEventListener("scroll",L,{passive:!0})}),dt(()=>{window.removeEventListener("scroll",L),H&&cancelAnimationFrame(H),j&&clearTimeout(j)});const T=(n,e)=>{y.value[n].post=e},tt=(n,e)=>{y.value[n].opinion=e},et=(n,e)=>{y.value[n].vote=e},st=(n,e)=>{_.value[n].comment=e},at=(n,e)=>{_.value[n].opinion=e},K=()=>{switch(l.value){case"users":return a.value.users.data.length;case"communities":return a.value.communities.data.length;case"posts":return a.value.posts.data.length;case"comments":return a.value.comments.data.length;default:return a.value.users.data.length+a.value.communities.data.length+a.value.posts.data.length+a.value.comments.data.length}};return(n,e)=>{const k=X("router-link");return i(),r("div",Tt,[t("div",Et,[t("h1",qt,' 搜索结果: "'+v(Z(q).query.q)+'" ',1),t("p",Mt," 找到 "+v(K())+" 个结果 ",1)]),t("div",Ut,[t("button",{class:N(["filter-tab",{active:l.value==="all"}]),onClick:e[0]||(e[0]=s=>l.value="all")}," 全部 ("+v(a.value.users.data.length+a.value.communities.data.length+a.value.posts.data.length+a.value.comments.data.length)+") ",3),t("button",{class:N(["filter-tab",{active:l.value==="users"}]),onClick:e[1]||(e[1]=s=>l.value="users")}," 用户 ("+v(a.value.users.data.length)+") ",3),t("button",{class:N(["filter-tab",{active:l.value==="communities"}]),onClick:e[2]||(e[2]=s=>l.value="communities")}," 社区 ("+v(a.value.communities.data.length)+") ",3),t("button",{class:N(["filter-tab",{active:l.value==="posts"}]),onClick:e[3]||(e[3]=s=>l.value="posts")}," 帖子 ("+v(a.value.posts.data.length)+") ",3),t("button",{class:N(["filter-tab",{active:l.value==="comments"}]),onClick:e[4]||(e[4]=s=>l.value="comments")}," 评论 ("+v(a.value.comments.data.length)+") ",3)]),m.value?(i(),r("div",Nt,e[5]||(e[5]=[t("div",{class:"loading-spinner"},null,-1),t("p",null,"正在搜索...",-1)]))):(i(),r(A,{key:1},[(l.value==="all"||l.value==="users")&&a.value.users.data.length>0?(i(),r("div",Ot,[e[6]||(e[6]=t("h2",{class:"section-title"},"用户",-1)),t("div",Rt,[(i(!0),r(A,null,F(a.value.users.data,s=>(i(),G(k,{key:s.id,to:`/user/${s.name}`,class:"user-card"},{default:B(()=>[t("img",{src:s.avatar,alt:s.username,class:"user-avatar"},null,8,Vt),t("div",Ht,[t("div",jt,v(s.name),1),t("div",Dt,v(s.nickname),1)])]),_:2},1032,["to"]))),128))])])):S("",!0),(l.value==="all"||l.value==="communities")&&a.value.communities.data.length>0?(i(),r("div",Lt,[e[7]||(e[7]=t("h2",{class:"section-title"},"社区",-1)),t("div",xt,[(i(!0),r(A,null,F(a.value.communities.data,s=>(i(),G(k,{key:s.id,to:`/r/${s.id}`,class:"community-card"},{default:B(()=>[t("div",At,[s.avatar?(i(),r("img",{key:0,src:s.avatar,alt:s.name},null,8,Bt)):S("",!0)]),t("div",Ft,[t("div",Gt,v(s.name),1),t("p",zt,v(s.description),1)])]),_:2},1032,["to"]))),128))])])):S("",!0),(l.value==="all"||l.value==="posts")&&y.value.length>0?(i(),r("div",Yt,[e[10]||(e[10]=t("h2",{class:"section-title"},"帖子",-1)),t("div",Jt,[(i(!0),r(A,null,F(y.value,(s,$)=>(i(),G(pt,{key:s.post.id,post:s.post,user:s.user,opinion:s.opinion,vote:s.vote,"onUpdate:post":f=>T($,f),"onUpdate:opinion":f=>tt($,f),"onUpdate:vote":f=>et($,f)},null,8,["post","user","opinion","vote","onUpdate:post","onUpdate:opinion","onUpdate:vote"]))),128)),R.value&&d.value?(i(),r("div",Kt,e[8]||(e[8]=[t("div",{class:"loading-spinner small"},null,-1),t("span",null,"加载更多帖子...",-1)]))):S("",!0),!R.value&&y.value.length>0?(i(),r("div",Qt,e[9]||(e[9]=[t("span",null,"已经到底了~",-1)]))):S("",!0)])])):S("",!0),(l.value==="all"||l.value==="comments")&&_.value.length>0?(i(),r("div",Wt,[e[13]||(e[13]=t("h2",{class:"section-title"},"评论",-1)),t("div",Xt,[(i(!0),r(A,null,F(_.value,(s,$)=>(i(),G(bt,{key:s.comment.id,comment:s.comment,user:s.user,opinion:s.opinion,post:s.post,"onUpdate:comment":f=>st($,f),"onUpdate:opinion":f=>at($,f)},null,8,["comment","user","opinion","post","onUpdate:comment","onUpdate:opinion"]))),128)),V.value&&O.value?(i(),r("div",Zt,e[11]||(e[11]=[t("div",{class:"loading-spinner small"},null,-1),t("span",null,"加载更多评论...",-1)]))):S("",!0),!V.value&&_.value.length>0?(i(),r("div",te,e[12]||(e[12]=[t("span",null,"已经到底了~",-1)]))):S("",!0)])])):S("",!0),K()===0?(i(),r("div",ee,e[14]||(e[14]=[t("h2",null,"未找到结果",-1),t("p",null,"尝试使用不同的关键词搜索",-1)]))):S("",!0)],64))])}}},ne=W(se,[["__scopeId","data-v-a09e2061"]]);export{ne as default};
