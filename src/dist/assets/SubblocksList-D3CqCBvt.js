import{_ as te,E as se,u as ae,r as c,l as D,o as oe,G as re,a as ne,q as $,c as r,b as n,d as e,e as M,s as le,h as x,y as ie,F as P,i as N,n as ce,t as d,C as z,w as S,f as F,g as de,m as ue,z as ve,T as pe,A as B,B as he}from"./index-CQU0DmQk.js";const we={class:"subblocks-list-page"},ge={class:"search-section"},me={class:"search-input-wrapper"},ke={class:"sort-section"},ye={class:"sort-options"},fe=["onClick"],be={class:"subblocks-container"},xe={key:0,class:"auth-required-container"},_e={class:"auth-message"},Ce={key:1,class:"loading-container"},Me={key:2,class:"error-container"},Se={key:3,class:"spaces-list"},Be={class:"space-header"},Te=["src","alt"],je={key:1},Ae={class:"space-info"},Ve={class:"space-name"},De={class:"space-description"},Ee={class:"space-actions"},Le=["onClick","disabled"],$e={key:0},Pe={key:1},Ne={key:1,class:"joined-badge"},ze={class:"space-stats"},Fe={class:"stat-item"},He={class:"stat-item"},Ue={class:"stat-item"},qe={key:0,class:"load-more-container"},Oe={key:0,class:"loading-more"},Re={key:0,class:"load-more-hint"},Ge={key:1,class:"load-more-error"},Ke={key:2,class:"no-more-data"},Qe={key:4,class:"no-data-container"},Je={__name:"SubblocksList",setup(We){he();const H=se(),U=ae(),l=c([]),v=c(""),k=c("popular"),p=c(0),E=c(0),h=c(!1),w=c(!1),y=c(!1),T=c(""),f=c(new Set),g=c(null),b=c(null);c(!1);const q=[{value:"popular",label:"热门"},{value:"newest",label:"最新"},{value:"members",label:"成员最多"}],_=D(()=>U.isAuthenticated),C=D(()=>p.value<E.value-1),O=D(()=>C.value&&!w.value&&!h.value&&l.value.length>3),R=s=>s?s>=1e6?(s/1e6).toFixed(1)+"M":s>=1e3?(s/1e3).toFixed(1)+"K":s.toString():"0",G=s=>{if(!s)return"未知";const t=new Date(s),a=Math.abs(new Date-t),i=Math.ceil(a/(1e3*60*60*24));return i===1?"今天":i<=7?`${i}天前`:i<=30?`${Math.ceil(i/7)}周前`:i<=365?`${Math.ceil(i/30)}个月前`:`${Math.ceil(i/365)}年前`},K=s=>{s.target.style.display="none"},u=async(s=0,t=!1)=>{if(_.value){performance.now();try{t?w.value=!0:(h.value=!0,y.value=!1);let o;if(v.value.trim()){if(o=await B.searchSpaces(v.value.trim(),s,20),o.success&&o.data.data.length>0){const a=o.data.data.map(A=>A.id),i=await B.getSpacesByIds(a);if(i.success){const A=o.data.data.map(m=>{const V=i.data.find(ee=>ee.space.id===m.id);return V?{space:{...V.space,name:m.name,description:m.description},isMember:V.isMember}:{space:{id:m.id,name:m.name,description:m.description,avatar:null,memberCount:0,postCount:0,createdAt:null},isMember:!1}});o.data.data=A}}}else o=await B.getPopularSpaces(s,20);if(o.success){const a=o.data.data||[];t?l.value=[...l.value,...a]:l.value=a,p.value=o.data.currentPage||s,E.value=o.data.totalPage||1}else throw new Error(o.message||"加载失败")}catch(o){console.error("加载社区失败:",o),y.value=!0,T.value=o.message||"网络错误，请稍后重试"}finally{h.value=!1,w.value=!1}}},L=async()=>{if(!(w.value||!C.value||h.value))try{await u(p.value+1,!0)}catch(s){console.error("加载更多失败:",s)}},Q=async()=>{y.value=!1,T.value="";try{await u(0,!1)}catch(s){console.error("重试加载失败:",s)}},J=()=>{b.value&&clearTimeout(b.value),b.value=setTimeout(async()=>{try{p.value=0,await u(0,!1)}catch(s){console.error("搜索失败:",s)}},500)},W=async()=>{v.value="",p.value=0;try{await u(0,!1)}catch(s){console.error("清除搜索失败:",s)}},X=async s=>{if(k.value!==s){k.value=s,p.value=0;try{k.value==="newest"?l.value.sort((t,o)=>new Date(o.space.createdAt)-new Date(t.space.createdAt)):k.value==="members"?l.value.sort((t,o)=>(o.space.memberCount||0)-(t.space.memberCount||0)):await u(0,!1)}catch(t){console.error("排序失败:",t)}}},Y=async s=>{if(!f.value.has(s))try{f.value.add(s);const t=await B.joinSpace(s);if(t.success){const o=l.value.findIndex(a=>a.space.id===s);o!==-1&&(l.value[o].isMember=!0,l.value[o].space.memberCount=(l.value[o].space.memberCount||0)+1),await H.loadPopularSpaces(!0)}else throw new Error(t.message||"加入失败")}catch(t){console.error("加入空间失败:",t)}finally{f.value.delete(s)}},Z=()=>{const s=new IntersectionObserver(a=>{a[0].isIntersecting&&C.value&&!w.value&&!h.value&&L()},{rootMargin:"200px",threshold:.1}),t=()=>{g.value&&s.observe(g.value)},o=()=>{g.value&&s.unobserve(g.value)};return $(()=>g.value,(a,i)=>{i&&s.unobserve(i),a&&s.observe(a)}),{observer:s,observeTrigger:t,unobserveTrigger:o}},I=()=>{window.scrollTo({top:0,behavior:"smooth"})};let j=null;return oe(async()=>{_.value&&await u();const{observer:s,observeTrigger:t,unobserveTrigger:o}=Z();j=()=>{o(),s.disconnect()},re(()=>{t()})}),ne(()=>{j&&j(),b.value&&clearTimeout(b.value)}),$(_,async s=>{s?await u():l.value=[]}),(s,t)=>{const o=de("router-link");return n(),r("div",we,[t[18]||(t[18]=e("div",{class:"page-header"},[e("h1",{class:"page-title"},"所有社区"),e("p",{class:"page-description"},"发现和加入感兴趣的社区")],-1)),e("div",ge,[e("div",me,[t[2]||(t[2]=e("svg",{class:"search-icon",xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("circle",{cx:"11",cy:"11",r:"8"}),e("path",{d:"m21 21-4.35-4.35"})],-1)),le(e("input",{"onUpdate:modelValue":t[0]||(t[0]=a=>v.value=a),onInput:J,type:"text",placeholder:"搜索社区...",class:"search-input"},null,544),[[ie,v.value]]),v.value?(n(),r("button",{key:0,onClick:W,class:"clear-search"},t[1]||(t[1]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)]))):x("",!0)])]),e("div",ke,[e("div",ye,[(n(),r(P,null,N(q,a=>e("button",{key:a.value,onClick:i=>X(a.value),class:ce(["sort-btn",{active:k.value===a.value}])},d(a.label),11,fe)),64))])]),e("div",be,[_.value?h.value&&l.value.length===0?(n(),r("div",Ce,t[5]||(t[5]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"加载社区中...",-1)]))):y.value?(n(),r("div",Me,[t[6]||(t[6]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("circle",{cx:"12",cy:"12",r:"10"}),e("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),e("line",{x1:"9",y1:"9",x2:"15",y2:"15"})],-1)),t[7]||(t[7]=e("h3",null,"加载失败",-1)),e("p",null,d(T.value),1),e("button",{onClick:Q,class:"retry-btn"}," 重试 ")])):l.value.length>0?(n(),r("div",Se,[(n(!0),r(P,null,N(l.value,a=>(n(),r("div",{key:a.space.id,class:"space-card"},[M(o,{to:`/r/${a.space.id}`,class:"space-link"},{default:S(()=>[e("div",Be,[e("div",{class:"space-avatar",style:ue({backgroundColor:a.space.color||"#6B7280"})},[a.space.avatar&&a.space.avatar!=="old avatar"?(n(),r("img",{key:0,src:a.space.avatar,alt:a.space.name,onError:K},null,40,Te)):(n(),r("span",je,d(a.space.name.charAt(0).toUpperCase()),1))],4),e("div",Ae,[e("h3",Ve,"r/"+d(a.space.name),1),e("p",De,d(a.space.description||"暂无描述"),1)]),e("div",Ee,[a.isMember?(n(),r("span",Ne,"已加入")):(n(),r("button",{key:0,onClick:ve(i=>Y(a.space.id),["prevent"]),disabled:f.value.has(a.space.id),class:"join-btn"},[f.value.has(a.space.id)?(n(),r("span",$e,"加入中...")):(n(),r("span",Pe,"加入"))],8,Le))])]),e("div",ze,[e("div",Fe,[t[8]||(t[8]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"}),e("circle",{cx:"9",cy:"7",r:"4"}),e("path",{d:"M22 21v-2a4 4 0 0 0-3-3.87"}),e("path",{d:"M16 3.13a4 4 0 0 1 0 7.75"})],-1)),e("span",null,d(R(a.space.memberCount))+" 成员",1)]),e("div",He,[t[9]||(t[9]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e("polyline",{points:"14,2 14,8 20,8"}),e("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e("polyline",{points:"10,9 9,9 8,9"})],-1)),e("span",null,d(a.space.postCount||0)+" 帖子",1)]),e("div",Ue,[t[10]||(t[10]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("circle",{cx:"12",cy:"12",r:"10"}),e("polyline",{points:"12,6 12,12 16,14"})],-1)),e("span",null,d(G(a.space.createdAt)),1)])])]),_:2},1032,["to"])]))),128)),C.value?(n(),r("div",qe,[w.value?(n(),r("div",Oe,t[11]||(t[11]=[e("div",{class:"loading-spinner small"},null,-1),e("span",null,"加载更多社区...",-1)]))):(n(),r("div",{key:1,ref_key:"loadMoreTrigger",ref:g,class:"load-more-trigger"},[O.value?(n(),r("div",Re,t[12]||(t[12]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"6 9 12 15 18 9"})],-1),e("span",null,"继续滚动查看更多",-1)]))):x("",!0)],512))])):x("",!0),y.value&&l.value.length>0?(n(),r("div",Ge,[t[13]||(t[13]=e("p",null,"加载更多失败",-1)),e("button",{onClick:L,class:"retry-load-more-btn"}," 重试 ")])):l.value.length>0?(n(),r("div",Ke,[t[14]||(t[14]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"9 11 12 14 22 4"}),e("path",{d:"M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"})],-1)),e("span",null,"已显示所有社区 ("+d(l.value.length)+" 个)",1)])):x("",!0)])):(n(),r("div",Qe,[t[16]||(t[16]=z('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-44a570cc><circle cx="12" cy="12" r="10" data-v-44a570cc></circle><path d="M8 14s1.5 2 4 2 4-2 4-2" data-v-44a570cc></path><line x1="9" y1="9" x2="9.01" y2="9" data-v-44a570cc></line><line x1="15" y1="9" x2="15.01" y2="9" data-v-44a570cc></line></svg><h3 data-v-44a570cc>暂无社区</h3><p data-v-44a570cc>还没有社区，快来创建第一个吧！</p>',3)),M(o,{to:"/create-space",class:"create-space-btn"},{default:S(()=>t[15]||(t[15]=[F(" 创建社区 ")])),_:1})])):(n(),r("div",xe,[e("div",_e,[t[4]||(t[4]=z('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-44a570cc><path d="M9 12l2 2 4-4" data-v-44a570cc></path><path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3" data-v-44a570cc></path><path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3" data-v-44a570cc></path><path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3" data-v-44a570cc></path><path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3" data-v-44a570cc></path></svg><h3 data-v-44a570cc>请登录查看社区</h3><p data-v-44a570cc>登录后可以浏览所有社区并加入感兴趣的社区</p>',3)),M(o,{to:"/login",class:"login-btn"},{default:S(()=>t[3]||(t[3]=[F(" 立即登录 ")])),_:1})])]))]),M(pe,{name:"fade"},{default:S(()=>[l.value.length>5?(n(),r("button",{key:0,onClick:I,class:"back-to-top",title:"回到顶部"},t[17]||(t[17]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"18 15 12 9 6 15"})],-1)]))):x("",!0)]),_:1})])}}},Ye=te(Je,[["__scopeId","data-v-44a570cc"]]);export{Ye as default};
