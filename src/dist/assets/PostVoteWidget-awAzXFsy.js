import{_ as se,r as T,u as ne,l as R,o as oe,g as ie,c as r,b as l,d as t,n as h,t as c,F as D,i as re,h as Y,m as H,e as Z,w as ee,f as te,k as U,z as le}from"./index-CQU0DmQk.js";const ae={class:"comment-vote-widget"},ce={class:"widget-header"},ue=["disabled"],ve={key:0,class:"loading-container"},de={key:1,class:"error-container"},pe={key:2,class:"empty-container"},ge={key:3,class:"vote-list"},me={class:"vote-header"},fe={class:"vote-info"},he={class:"vote-type-text"},_e={class:"vote-stats"},we={class:"vote-initiator"},Ie={class:"vote-time-info"},Te={class:"time-item"},ye={class:"time-value"},Ee={class:"time-item"},Ce={class:"time-value"},Se={class:"time-item remaining-time"},ke={class:"vote-progress-section"},Ne={class:"progress-bar-wrapper"},$e={class:"progress-bar-dual"},be={key:1,class:"progress-placeholder"},Oe={class:"progress-stats"},Ae={class:"positive-percentage"},Ve={class:"negative-percentage"},xe={class:"comment-preview"},Pe={key:0,class:"vote-actions"},Le=["onClick","disabled","title"],Me={key:0},Ge={key:1},Be=["onClick","disabled","title"],Re={key:0},De={key:1},He={key:1,class:"expired-notice"},Ue={key:2,class:"login-notice"},We={__name:"CommentVoteWidget",props:{postId:{type:[Number,String],required:!0},spaceId:{type:[Number,String],required:!0}},emits:["vote-cast"],setup(S,{expose:W,emit:j}){const g=S,_=j,m=T(!1),f=T(null),w=T([]),v=T({}),z=ne(),N=R(()=>z.isLoggedIn),$=R(()=>{const i=[],e=s=>{for(const o of s)o.comment.vote&&o.comment.vote.vote!==null&&i.push(o),o.children&&o.children.length>0&&e(o.children)};return e(w.value),i.slice(0,3)}),I=async()=>{m.value=!0,f.value=null;try{const i=await U.get(`/comment/post?postId=${g.postId}&page=0`);i.success?w.value=i.data.data||[]:f.value=i.message||"获取评论投票失败"}catch{f.value="网络错误，请稍后重试"}finally{m.value=!1}},V=async()=>{await I()},b=async(i,e)=>{if(!v.value[i]){v.value[i]=!0;try{const s=await U.post("/opinion/vote?isCommon=true",{id:i,isPositive:e});s.success?(x(i,e),_("vote-cast",{voteId:i,isPositive:e,success:!0,message:`${e?"赞成":"反对"}投票成功`})):(console.error("投票失败:",s.message),_("vote-cast",{voteId:i,isPositive:e,success:!1,message:s.message||"投票失败"}))}catch(s){console.error("投票请求失败:",s),_("vote-cast",{voteId:i,isPositive:e,success:!1,message:"网络错误，请稍后重试"})}finally{v.value[i]=!1}}},x=(i,e)=>{const s=o=>{for(const n of o){if(n.comment.vote&&n.comment.vote.vote&&n.comment.vote.vote.id===i){const a=n.comment.vote.vote,u=n.comment.vote.opinion,d=u?u.opinionStatus:"NIL";let p="NIL";return d==="POSITIVE"&&e||d==="NEGATIVE"&&!e?p="NIL":p=e?"POSITIVE":"NEGATIVE",d==="POSITIVE"?a.positiveCount-=1:d==="NEGATIVE"&&(a.negativeCount-=1),p==="POSITIVE"?a.positiveCount+=1:p==="NEGATIVE"&&(a.negativeCount+=1),u?(u.opinionStatus=p,u.updatedAt=new Date().toISOString()):n.comment.vote.opinion={mergeId:i,opinionStatus:p,updatedAt:new Date().toISOString()},!0}if(n.children&&n.children.length>0&&s(n.children))return!0}return!1};s(w.value)},q=i=>({DELETE_COMMENT:"🗑️",PIN_COMMENT:"📌",UNPIN_COMMENT:"📌❌"})[i]||"🗳️",F=i=>({DELETE_COMMENT:"删除评论",PIN_COMMENT:"置顶评论",UNPIN_COMMENT:"取消置顶"})[i]||i,J=i=>({DELETE_COMMENT:"delete",PIN_COMMENT:"pin",UNPIN_COMMENT:"unpin"})[i]||"default",K=i=>{const e=i.vote.positiveCount+i.vote.negativeCount;return e===0?"暂无投票":`${Math.round(i.vote.positiveCount/e*100)}% 赞成 (${e}票)`},Q=i=>{const e=i.replace(/<[^>]*>/g,"").trim();return e.length>30?e.substring(0,30)+"...":e},P=i=>new Date>new Date(i),y=i=>new Date(i).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),L=i=>{const e=new Date(i).getTime(),s=new Date().getTime(),o=e-s;if(o<=0)return"已结束";const n=Math.floor(o/(1e3*60*60*24)),a=Math.floor(o%(1e3*60*60*24)/(1e3*60*60)),u=Math.floor(o%(1e3*60*60)/(1e3*60));return n>0?`${n}天${a}小时`:a>0?`${a}小时${u}分钟`:u>0?`${u}分钟`:"即将结束"},X=i=>{const e=new Date(i).getTime(),s=new Date().getTime(),o=e-s;if(o<=0)return"expired";const n=Math.floor(o/(1e3*60*60));return n<=1?"urgent":n<=24?"warning":"normal"},M=(i,e)=>!i||i.opinionStatus==="NIL"?e?"赞成":"反对":e?i.opinionStatus==="POSITIVE"?"已赞成":"赞成":i.opinionStatus==="NEGATIVE"?"已反对":"反对",O=(i,e)=>!i||i.opinionStatus==="NIL"?e?"投赞成票":"投反对票":e?i.opinionStatus==="POSITIVE"?"取消赞成":"改为赞成":i.opinionStatus==="NEGATIVE"?"取消反对":"改为反对",E=i=>{const e=Number(i.vote.positiveCount)||0,s=Number(i.vote.negativeCount)||0,o=e+s;if(o===0)return{positive:0,negative:0};const n=Math.round(e/o*100),a=100-n;return{positive:n,negative:a}};return oe(()=>{I()}),W({refreshVotes:I}),(i,e)=>{const s=ie("router-link");return l(),r("div",ae,[t("div",ce,[e[1]||(e[1]=t("h3",{class:"widget-title"},"评论投票",-1)),t("button",{onClick:V,disabled:m.value,class:"refresh-btn",title:"刷新投票列表"},[(l(),r("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:h({spinning:m.value})},e[0]||(e[0]=[t("polyline",{points:"23 4 23 10 17 10"},null,-1),t("polyline",{points:"1 20 1 14 7 14"},null,-1),t("path",{d:"m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"},null,-1)]),2))],8,ue)]),m.value?(l(),r("div",ve,e[2]||(e[2]=[t("div",{class:"loading-spinner"},null,-1),t("p",null,"加载中...",-1)]))):f.value?(l(),r("div",de,[t("p",null,c(f.value),1),t("button",{onClick:I,class:"retry-btn"},"重试")])):$.value.length===0?(l(),r("div",pe,e[3]||(e[3]=[t("p",null,"暂无进行中的投票",-1)]))):(l(),r("div",ge,[(l(!0),r(D,null,re($.value,o=>{var n;return l(),r("div",{key:o.comment.comment.id,class:"vote-item"},[t("div",me,[t("div",{class:h(["vote-type-badge",J(o.comment.vote.vote.voteType)])},c(q(o.comment.vote.vote.voteType)),3),t("div",fe,[t("div",he,c(F(o.comment.vote.vote.voteType)),1),t("div",_e,c(K(o.comment.vote)),1),t("div",we," 发起人: "+c(((n=o.comment.vote.initiator)==null?void 0:n.username)||"未知"),1)])]),t("div",Ie,[t("div",Te,[e[4]||(e[4]=t("span",{class:"time-label"},"开始:",-1)),t("span",ye,c(y(o.comment.vote.vote.startAt)),1)]),t("div",Ee,[e[5]||(e[5]=t("span",{class:"time-label"},"结束:",-1)),t("span",Ce,c(y(o.comment.vote.vote.endAt)),1)]),t("div",Se,[e[6]||(e[6]=t("span",{class:"time-label"},"剩余:",-1)),t("span",{class:h(["time-value",X(o.comment.vote.vote.endAt)])},c(L(o.comment.vote.vote.endAt)),3)])]),t("div",ke,[t("div",Ne,[t("div",$e,[o.comment.vote.vote.positiveCount+o.comment.vote.vote.negativeCount>0?(l(),r(D,{key:0},[t("div",{class:"progress-fill-positive",style:H({width:`${E(o.comment.vote).positive}%`})},null,4),t("div",{class:"progress-fill-negative",style:H({width:`${E(o.comment.vote).negative}%`})},null,4)],64)):(l(),r("div",be,e[7]||(e[7]=[t("span",null,"暂无投票",-1)])))]),t("div",Oe,[t("span",Ae,c(E(o.comment.vote).positive)+"%",1),t("span",Ve,c(E(o.comment.vote).negative)+"%",1)])])]),t("div",xe,c(Q(o.comment.comment.content)),1),N.value&&!P(o.comment.vote.vote.endAt)?(l(),r("div",Pe,[t("button",{onClick:a=>b(o.comment.vote.vote.id,!0),disabled:v.value[o.comment.vote.vote.id],class:h([{active:o.comment.vote.opinion&&o.comment.vote.opinion.opinionStatus==="POSITIVE"},"vote-btn positive-btn"]),title:O(o.comment.vote.opinion,!0)},[e[8]||(e[8]=t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("polyline",{points:"18 15 12 9 6 15"})],-1)),v.value[o.comment.vote.vote.id]?(l(),r("span",Me,"...")):(l(),r("span",Ge,c(M(o.comment.vote.opinion,!0)),1))],10,Le),t("button",{onClick:a=>b(o.comment.vote.vote.id,!1),disabled:v.value[o.comment.vote.vote.id],class:h([{active:o.comment.vote.opinion&&o.comment.vote.opinion.opinionStatus==="NEGATIVE"},"vote-btn negative-btn"]),title:O(o.comment.vote.opinion,!1)},[e[9]||(e[9]=t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("polyline",{points:"6 9 12 15 18 9"})],-1)),v.value[o.comment.vote.vote.id]?(l(),r("span",Re,"...")):(l(),r("span",De,c(M(o.comment.vote.opinion,!1)),1))],10,Be)])):P(o.comment.vote.vote.endAt)?(l(),r("div",He," 投票已结束 ")):N.value?Y("",!0):(l(),r("div",Ue,[Z(s,{to:"/login",class:"login-link"},{default:ee(()=>e[10]||(e[10]=[te("登录参与投票")])),_:1})]))])}),128))]))])}}},$t=se(We,[["__scopeId","data-v-a2ae38ee"]]),je={class:"post-vote-widget"},ze={class:"widget-header"},qe={class:"widget-title"},Fe=["disabled"],Je={key:0,class:"loading-container"},Ke={key:1,class:"error-container"},Qe={key:2,class:"empty-container"},Xe={key:3,class:"vote-list"},Ye={class:"vote-header"},Ze={class:"vote-info"},et={class:"vote-type-text"},tt={class:"vote-stats"},st={class:"vote-initiator"},nt={class:"vote-time-info"},ot={class:"time-item"},it={class:"time-value"},rt={class:"time-item"},lt={class:"time-value"},at={class:"time-item remaining-time"},ct={class:"vote-progress-section"},ut={class:"progress-bar-wrapper"},vt={class:"progress-bar-dual"},dt={key:1,class:"progress-placeholder"},pt={class:"progress-stats"},gt={class:"positive-percentage"},mt={class:"negative-percentage"},ft={key:0,class:"post-preview"},ht={key:1,class:"vote-actions"},_t=["onClick","disabled","title"],wt={key:0},It={key:1},Tt=["onClick","disabled","title"],yt={key:0},Et={key:1},Ct={key:2,class:"expired-notice"},St={key:3,class:"login-notice"},kt={__name:"PostVoteWidget",props:{spaceId:{type:[Number,String],default:null},postVoteData:{type:Object,default:null},showCurrentPostOnly:{type:Boolean,default:!1}},emits:["vote-cast","refresh-requested"],setup(S,{expose:W,emit:j}){const g=S,_=j,m=T(!1),f=T(null),w=T([]),v=T({}),z=ne(),N=R(()=>z.isLoggedIn),$=R(()=>{if(g.showCurrentPostOnly&&g.postVoteData){const e=g.postVoteData;return y(e.vote.endAt)?[]:[e]}return w.value.filter(e=>!y(e.vote.endAt)).slice(0,3)}),I=async()=>{if(g.showCurrentPostOnly){m.value=!1;return}m.value=!0,f.value=null;try{let e="/vote/post";g.spaceId&&(e=`/vote/space/${g.spaceId}?type=POST`);const s=await U.get(e);s.success?w.value=s.data||[]:(f.value=s.message||"获取帖子投票失败",console.error("获取帖子投票失败:",f.value))}catch(e){console.error("获取帖子投票失败:",e),f.value="网络错误，请稍后重试"}finally{m.value=!1}},V=async()=>{if(g.showCurrentPostOnly){_("refresh-requested");return}await I()},b=async(e,s)=>{if(!v.value[e]){v.value[e]=!0;try{const o=await U.post("/opinion/vote?isCommon=true",{id:e,isPositive:s});o.success?(q(e,s),_("vote-cast",{voteId:e,isPositive:s,success:!0,message:`${s?"赞成":"反对"}投票成功`})):(console.error("投票失败:",o.message),_("vote-cast",{voteId:e,isPositive:s,success:!1,message:o.message||"投票失败"}))}catch(o){console.error("投票请求失败:",o),_("vote-cast",{voteId:e,isPositive:s,success:!1,message:"网络错误，请稍后重试"})}finally{v.value[e]=!1}}},x=(e,s)=>!e||e.opinionStatus==="NIL"?!1:!!(s&&e.opinionStatus==="POSITIVE"||!s&&e.opinionStatus==="NEGATIVE"),q=(e,s)=>{if(g.showCurrentPostOnly&&g.postVoteData){const k=g.postVoteData;if(k.vote.id===e){const G=k.vote,A=k.opinion,B=A?A.opinionStatus:"NIL";let C="NIL";B==="POSITIVE"&&s||B==="NEGATIVE"&&!s?C="NIL":C=s?"POSITIVE":"NEGATIVE",B==="POSITIVE"?G.positiveCount-=1:B==="NEGATIVE"&&(G.negativeCount-=1),C==="POSITIVE"?G.positiveCount+=1:C==="NEGATIVE"&&(G.negativeCount+=1),A?(A.opinionStatus=C,A.updatedAt=new Date().toISOString()):k.opinion={mergeId:e,opinionStatus:C,updatedAt:new Date().toISOString()};return}}const o=w.value.findIndex(k=>k.vote.id===e);if(o===-1)return;const n=w.value[o],a=n.vote,u=n.opinion,d=u?u.opinionStatus:"NIL";let p="NIL";d==="POSITIVE"&&s||d==="NEGATIVE"&&!s?p="NIL":p=s?"POSITIVE":"NEGATIVE",d==="POSITIVE"?a.positiveCount-=1:d==="NEGATIVE"&&(a.negativeCount-=1),p==="POSITIVE"?a.positiveCount+=1:p==="NEGATIVE"&&(a.negativeCount+=1),u?(u.opinionStatus=p,u.updatedAt=new Date().toISOString()):n.opinion={mergeId:e,opinionStatus:p,updatedAt:new Date().toISOString()}},F=e=>({DELETE_POST:"🗑️",ARCHIVE_POST:"📦",UNARCHIVE_POST:"📦❌"})[e]||"🗳️",J=e=>({DELETE_POST:"删除帖子",ARCHIVE_POST:"归档帖子",UNARCHIVE_POST:"取消归档"})[e]||e,K=e=>({DELETE_POST:"delete",ARCHIVE_POST:"archive",UNARCHIVE_POST:"unarchive"})[e]||"default",Q=e=>{const s=e.vote.positiveCount+e.vote.negativeCount;return s===0?"暂无投票":`${Math.round(e.vote.positiveCount/s*100)}% 赞成 (${s}票)`},P=e=>e&&e.length>30?e.substring(0,30)+"...":e||"无标题",y=e=>new Date>new Date(e),L=e=>new Date(e).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),X=e=>{const s=new Date(e).getTime(),o=new Date().getTime(),n=s-o;if(n<=0)return"已结束";const a=Math.floor(n/(1e3*60*60*24)),u=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),d=Math.floor(n%(1e3*60*60)/(1e3*60));return a>0?`${a}天${u}小时`:u>0?`${u}小时${d}分钟`:d>0?`${d}分钟`:"即将结束"},M=e=>{const s=new Date(e).getTime(),o=new Date().getTime(),n=s-o;if(n<=0)return"expired";const a=Math.floor(n/(1e3*60*60));return a<=1?"urgent":a<=24?"warning":"normal"},O=(e,s)=>!e||e.opinionStatus==="NIL"?s?"赞成":"反对":s?e.opinionStatus==="POSITIVE"?"已赞成":"赞成":e.opinionStatus==="NEGATIVE"?"已反对":"反对",E=(e,s)=>!e||e.opinionStatus==="NIL"?s?"投赞成票":"投反对票":s?e.opinionStatus==="POSITIVE"?"取消赞成":"改为赞成":e.opinionStatus==="NEGATIVE"?"取消反对":"改为反对",i=e=>{const s=Number(e.vote.positiveCount)||0,o=Number(e.vote.negativeCount)||0,n=s+o;if(n===0)return{positive:0,negative:0};const a=Math.round(s/n*100),u=100-a;return{positive:a,negative:u}};return oe(()=>{I()}),W({refreshVotes:V}),(e,s)=>{const o=ie("router-link");return l(),r("div",je,[t("div",ze,[t("h3",qe,c((S.showCurrentPostOnly,"帖子投票")),1),t("button",{onClick:V,disabled:m.value,class:"refresh-btn",title:"刷新投票列表"},[(l(),r("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:h({spinning:m.value})},s[1]||(s[1]=[t("polyline",{points:"23 4 23 10 17 10"},null,-1),t("polyline",{points:"1 20 1 14 7 14"},null,-1),t("path",{d:"m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"},null,-1)]),2))],8,Fe)]),m.value?(l(),r("div",Je,s[2]||(s[2]=[t("div",{class:"loading-spinner"},null,-1),t("p",null,"加载中...",-1)]))):f.value?(l(),r("div",Ke,[t("p",null,c(f.value),1),t("button",{onClick:I,class:"retry-btn"},"重试")])):$.value.length===0?(l(),r("div",Qe,s[3]||(s[3]=[t("p",null,"暂无进行中的投票",-1)]))):(l(),r("div",Xe,[(l(!0),r(D,null,re($.value,n=>{var a,u;return l(),r("div",{key:n.vote.id,class:h(["vote-item",{"current-post-vote":S.showCurrentPostOnly}])},[t("div",Ye,[t("div",{class:h(["vote-type-badge",K(n.vote.voteType)])},c(F(n.vote.voteType)),3),t("div",Ze,[t("div",et,c(J(n.vote.voteType)),1),t("div",tt,c(Q(n)),1),t("div",st," 发起人: "+c(((a=n.initiator)==null?void 0:a.username)||((u=n.initiator)==null?void 0:u.nickname)||"未知"),1)])]),t("div",nt,[t("div",ot,[s[4]||(s[4]=t("span",{class:"time-label"},"开始:",-1)),t("span",it,c(L(n.vote.startAt)),1)]),t("div",rt,[s[5]||(s[5]=t("span",{class:"time-label"},"结束:",-1)),t("span",lt,c(L(n.vote.endAt)),1)]),t("div",at,[s[6]||(s[6]=t("span",{class:"time-label"},"剩余:",-1)),t("span",{class:h(["time-value",M(n.vote.endAt)])},c(X(n.vote.endAt)),3)])]),t("div",ct,[t("div",ut,[t("div",vt,[n.vote.positiveCount+n.vote.negativeCount>0?(l(),r(D,{key:0},[t("div",{class:"progress-fill-positive",style:H({width:`${i(n).positive}%`})},null,4),t("div",{class:"progress-fill-negative",style:H({width:`${i(n).negative}%`})},null,4)],64)):(l(),r("div",dt,s[7]||(s[7]=[t("span",null,"暂无投票",-1)])))]),t("div",pt,[t("span",gt,c(i(n).positive)+"%",1),t("span",mt,c(i(n).negative)+"%",1)])])]),S.showCurrentPostOnly?Y("",!0):(l(),r("div",ft,[Z(o,{to:`/r/${n.vote.spaceId}/post/${n.vote.postId}`,class:"post-link",onClick:s[0]||(s[0]=le(()=>{},["stop"]))},{default:ee(()=>[te(c(P(n.vote.postSubject)),1)]),_:2},1032,["to"])])),N.value&&!y(n.vote.endAt)?(l(),r("div",ht,[t("button",{onClick:d=>b(n.vote.id,!0),disabled:v.value[n.vote.id]||x(n.opinion,!0),class:h([{active:n.opinion&&n.opinion.opinionStatus==="POSITIVE"},"vote-btn positive-btn"]),title:E(n.opinion,!0)},[s[8]||(s[8]=t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("polyline",{points:"18 15 12 9 6 15"})],-1)),v.value[n.vote.id]?(l(),r("span",wt,"...")):(l(),r("span",It,c(O(n.opinion,!0)),1))],10,_t),t("button",{onClick:d=>b(n.vote.id,!1),disabled:v.value[n.vote.id]||x(n.opinion,!1),class:h([{active:n.opinion&&n.opinion.opinionStatus==="NEGATIVE"},"vote-btn negative-btn"]),title:E(n.opinion,!1)},[s[9]||(s[9]=t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("polyline",{points:"6 9 12 15 18 9"})],-1)),v.value[n.vote.id]?(l(),r("span",yt,"...")):(l(),r("span",Et,c(O(n.opinion,!1)),1))],10,Tt)])):y(n.vote.endAt)?(l(),r("div",Ct," 投票已结束 ")):N.value?Y("",!0):(l(),r("div",St,[Z(o,{to:"/login",class:"login-link"},{default:ee(()=>s[10]||(s[10]=[te("登录参与投票")])),_:1})]))],2)}),128))]))])}}},bt=se(kt,[["__scopeId","data-v-c79bb4e1"]]);export{$t as C,bt as P};
