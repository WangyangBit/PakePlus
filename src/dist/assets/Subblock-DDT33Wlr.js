import{_ as J,u as ae,r as E,l as x,c as a,b as s,d as e,h as $,n as P,t as m,F as B,m as se,p as ne,v as G,q as ie,o as K,i as q,s as z,x as oe,y as ee,f as Q,z as ue,A as H,j as Y,B as re,C as ce,D as ve,a as de,e as W,w as te,g as pe,k as le}from"./index-CQU0DmQk.js";import{P as me}from"./PostCard-AwN3vA5N.js";const fe={class:"vote-info"},ge={class:"vote-type-text"},he={class:"vote-counts-simple"},ye={class:"user-section"},_e={class:"user-info initiator-user"},be=["src","alt"],Ee={class:"user-details"},ke={class:"user-name"},Ce={key:0,class:"user-section"},$e={class:"user-info target-user"},we=["src","alt"],Te={class:"user-details"},Se={class:"user-name"},Ie={key:0,class:"update-details-simple"},Ue={key:0,class:"update-item"},Me={class:"update-content"},Ve={key:1,class:"update-item"},Pe={key:1,class:"action-details-simple"},Ae={key:0,class:"reason-item"},Re={class:"reason-content"},De={class:"progress-bar-wrapper"},Ne={class:"progress-bar-dual"},xe={key:1,class:"progress-placeholder"},Le={class:"progress-stats"},Oe={class:"positive-percentage"},Be={class:"negative-percentage"},Fe={class:"vote-buttons-reference"},He=["title","disabled"],je={key:0},Xe=["title","disabled"],qe={key:0},Ge={__name:"VoteCard",props:{vote:{type:Object,required:!0},spaceId:{type:Number,required:!0},isCompact:{type:Boolean,default:!1},isRefreshing:{type:Boolean,default:!1}},emits:["vote-cast","vote-updated"],setup(l,{emit:A}){const d=l,U=A,M=ae(),p=E(!1),k=x(()=>({PIN_COMMENT:"置顶评论",UNPIN_COMMENT:"取消置顶评论",DELETE_COMMENT:"删除评论",ARCHIVE_POST:"归档帖子",UNARCHIVE_POST:"取消归档帖子",DELETE_POST:"删除帖子",UPDATE_SPACE:"修改空间信息",EXPEL_USER:"驱逐用户",MUTE_USER:"禁言用户"})[d.vote.vote.voteType]||d.vote.vote.voteType),f=x(()=>{const n=["UPDATE_SPACE","EXPEL_USER","MUTE_USER"],v=["DELETE_POST","ARCHIVE_POST"];return n.includes(d.vote.vote.voteType)?"high":v.includes(d.vote.vote.voteType)?"medium":"normal"}),b=x(()=>{const n=d.vote.vote.positiveCount+d.vote.vote.negativeCount;return n===0?0:Math.round(d.vote.vote.positiveCount/n*100)}),C=x(()=>b.value>=60?"success":b.value>=40?"warning":"danger"),_=x(()=>new Date(d.vote.vote.endAt)<new Date),i=x(()=>{var n;return((n=d.vote.opinion)==null?void 0:n.opinionStatus)||null});x(()=>i.value!==null);const N=n=>i.value?!!(n&&i.value==="POSITIVE"||!n&&i.value==="NEGATIVE"):!1,y=n=>{const v=new Date(n).getTime(),I=new Date().getTime(),w=v-I;if(w<=0)return"已结束";const u=Math.floor(w/(1e3*60*60*24)),o=Math.floor(w%(1e3*60*60*24)/(1e3*60*60)),g=Math.floor(w%(1e3*60*60)/(1e3*60));return u>0?`${u}天${o}小时`:o>0?`${o}小时${g}分钟`:g>0?`${g}分钟`:"即将结束"},S=n=>{const v=new Date(n).getTime(),I=new Date().getTime(),w=v-I;if(w<=0)return"expired";const u=Math.floor(w/(1e3*60*60));return u<=1?"urgent":u<=24?"warning":"normal"},V=n=>({UPDATE_SPACE:"🏠",EXPEL_USER:"🚫",MUTE_USER:"🔇",DELETE_POST:"🗑️",ARCHIVE_POST:"📦",UNARCHIVE_POST:"📦",DELETE_COMMENT:"🗑️",PIN_COMMENT:"📌",UNPIN_COMMENT:"📌"})[n]||"🗳️",L=n=>({UPDATE_SPACE:"space-update",EXPEL_USER:"expel",MUTE_USER:"mute",DELETE_POST:"delete",ARCHIVE_POST:"archive",UNARCHIVE_POST:"unarchive",DELETE_COMMENT:"delete",PIN_COMMENT:"pin",UNPIN_COMMENT:"unpin"})[n]||"default",O=async n=>{var R;if(!M.isAuthenticated||p.value||_.value||d.isRefreshing)return;const v=new Date(d.vote.vote.startAt);new Date-v<1e3&&await new Promise(T=>setTimeout(T,500));const u=i.value,o=d.vote.vote.positiveCount,g=d.vote.vote.negativeCount;try{p.value=!0;const T=n?"POSITIVE":"NEGATIVE";let D="";i.value===null?D="first_vote":i.value===T?D="cancel_vote":D="switch_vote";const X=((R=M.user)==null?void 0:R.userId)===d.vote.vote.initiator;j(n);const Z=await G.castVote({id:d.vote.vote.id,isPositive:n},!1);if(Z.success){U("vote-cast",{voteId:d.vote.vote.id,isPositive:n,previousStatus:u,isInitiator:X,changeType:D,success:!0,message:F(D,n)});const aa=F(D,n)}else console.error("投票失败 - 服务器返回失败状态，回滚本地状态:",Z),h(u,o,g),U("vote-cast",{voteId:d.vote.vote.id,isPositive:n,success:!1,message:Z.message||"投票失败"})}catch(T){console.error("投票操作失败:",T),h(u,o,g);let D="投票失败，请稍后重试";T.message&&(T.message.includes("401")?D="请先登录":T.message.includes("403")?D="您没有权限进行投票":T.message.includes("404")&&(D="投票不存在或已过期")),console.error("用户错误提示:",D),U("vote-cast",{voteId:d.vote.vote.id,isPositive:n,success:!1,message:D})}finally{p.value=!1}},F=(n,v)=>{const I=v?"支持":"反对";switch(n){case"first_vote":return`已投${I}票`;case"cancel_vote":return`已取消${I}票`;case"switch_vote":return`已改票为${I}`;default:return`${I}投票成功`}},j=n=>{const v=i.value,I=n?"POSITIVE":"NEGATIVE";let w=null;v==="POSITIVE"&&n||v==="NEGATIVE"&&!n?w=null:w=I,v==="POSITIVE"?d.vote.vote.positiveCount-=1:v==="NEGATIVE"&&(d.vote.vote.negativeCount-=1),w==="POSITIVE"?d.vote.vote.positiveCount+=1:w==="NEGATIVE"&&(d.vote.vote.negativeCount+=1),d.vote.opinion?(d.vote.opinion.opinionStatus=w,d.vote.opinion.updatedAt=new Date().toISOString()):d.vote.opinion={mergeId:d.vote.vote.id,opinionStatus:w,updatedAt:new Date().toISOString()}},h=(n,v,I)=>{d.vote.opinion&&(d.vote.opinion.opinionStatus=n),d.vote.vote.positiveCount=v,d.vote.vote.negativeCount=I},t=n=>(n==null?void 0:n.avatar)||"/default-avatar.png",c=(n,v)=>!n||n.opinionStatus===null?v?"投支持票":"投反对票":v?n.opinionStatus==="POSITIVE"?"取消支持":"改为支持":n.opinionStatus==="NEGATIVE"?"取消反对":"改为反对",r=()=>{const n=Number(d.vote.vote.positiveCount)||0,v=Number(d.vote.vote.negativeCount)||0,I=n+v;if(I===0)return{positive:0,negative:0};const w=Math.round(n/I*100),u=100-w;return{positive:w,negative:u}};return(n,v)=>{var I,w,u,o,g,R;return s(),a("div",{class:P(["vote-card",{expired:_.value,[`importance-${f.value}`]:!0,compact:l.isCompact}])},[e("div",{class:P(["vote-header",{compact:l.isCompact}])},[e("div",{class:P(["vote-type-badge",L(l.vote.vote.voteType)])},m(V(l.vote.vote.voteType)),3),e("div",fe,[e("div",ge,m(k.value),1),e("div",he," 支持"+m(l.vote.vote.positiveCount)+" / 反对"+m(l.vote.vote.negativeCount),1)]),e("div",{class:P(["time-remaining-badge",S(l.vote.vote.endAt)])},m(y(l.vote.vote.endAt)),3)],2),e("div",{class:P(["vote-users-info",{compact:l.isCompact}])},[e("div",ye,[v[2]||(v[2]=e("div",{class:"user-section-title"},"发起者",-1)),e("div",_e,[e("img",{src:t(l.vote.initiator),alt:(I=l.vote.initiator)==null?void 0:I.nickname,class:"user-avatar"},null,8,be),e("div",Ee,[e("span",ke,m(((w=l.vote.initiator)==null?void 0:w.nickname)||((u=l.vote.initiator)==null?void 0:u.username)||"未知用户"),1)])])]),l.vote.vote.voteType==="EXPEL_USER"||l.vote.vote.voteType==="MUTE_USER"?(s(),a("div",Ce,[v[3]||(v[3]=e("div",{class:"user-section-title target-title"},"投票对象",-1)),e("div",$e,[e("img",{src:t(l.vote.relatedUser),alt:(o=l.vote.relatedUser)==null?void 0:o.nickname,class:"user-avatar"},null,8,we),e("div",Te,[e("span",Se,m(((g=l.vote.relatedUser)==null?void 0:g.nickname)||((R=l.vote.relatedUser)==null?void 0:R.username)||"未知用户"),1)])])])):$("",!0)],2),e("div",{class:P(["vote-details-simple",{compact:l.isCompact}])},[l.vote.vote.voteType==="UPDATE_SPACE"?(s(),a("div",Ie,[l.vote.vote.first?(s(),a("div",Ue,[v[4]||(v[4]=e("span",{class:"update-label"},"📝 新描述：",-1)),e("span",Me,m(l.isCompact&&l.vote.vote.first.length>40?l.vote.vote.first.substring(0,40)+"...":l.vote.vote.first),1)])):$("",!0),l.vote.vote.second&&l.vote.vote.second!=="old"?(s(),a("div",Ve,v[5]||(v[5]=[e("span",{class:"update-label"},"📷 头像：",-1),e("span",{class:"update-content"},"更换空间头像",-1)]))):$("",!0)])):l.vote.vote.voteType==="EXPEL_USER"||l.vote.vote.voteType==="MUTE_USER"?(s(),a("div",Pe,[l.vote.vote.second?(s(),a("div",Ae,[v[6]||(v[6]=e("span",{class:"reason-label"},"💬 原因：",-1)),e("span",Re,m(l.isCompact&&l.vote.vote.second.length>30?l.vote.vote.second.substring(0,30)+"...":l.vote.vote.second),1)])):$("",!0)])):$("",!0)],2),e("div",{class:P(["vote-progress-section",{compact:l.isCompact}])},[e("div",De,[e("div",Ne,[l.vote.vote.positiveCount+l.vote.vote.negativeCount>0?(s(),a(B,{key:0},[e("div",{class:"progress-fill-positive",style:se({width:`${r().positive}%`})},null,4),e("div",{class:"progress-fill-negative",style:se({width:`${r().negative}%`})},null,4)],64)):(s(),a("div",xe,v[7]||(v[7]=[e("span",null,"暂无投票",-1)])))]),e("div",Le,[e("span",Oe,m(r().positive)+"%",1),e("span",Be,m(r().negative)+"%",1)])])],2),!_.value&&ne(M).isAuthenticated?(s(),a("div",{key:0,class:P(["vote-actions-reference",{compact:l.isCompact}])},[e("div",Fe,[e("button",{class:P(["vote-btn-reference positive-btn",{active:i.value==="POSITIVE",loading:p.value,compact:l.isCompact}]),title:c(l.vote.opinion,!0),onClick:v[0]||(v[0]=T=>O(!0)),disabled:N(!0)||p.value||l.isRefreshing},[v[8]||(v[8]=e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"18 15 12 9 6 15"})],-1)),l.isCompact?$("",!0):(s(),a("span",je,m(i.value==="POSITIVE"?"已支持":"支持"),1))],10,He),e("button",{class:P(["vote-btn-reference negative-btn",{active:i.value==="NEGATIVE",loading:p.value,compact:l.isCompact}]),title:c(l.vote.opinion,!1),onClick:v[1]||(v[1]=T=>O(!1)),disabled:N(!1)||p.value||l.isRefreshing},[v[9]||(v[9]=e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"6 9 12 15 18 9"})],-1)),l.isCompact?$("",!0):(s(),a("span",qe,m(i.value==="NEGATIVE"?"已反对":"反对"),1))],10,Xe)])],2)):$("",!0),_.value?(s(),a("div",{key:1,class:P(["vote-status-simple",{compact:l.isCompact}])},[e("span",{class:P(["status-text-simple",C.value])},m(b.value>=50?"✅ 已通过":"❌ 未通过"),3)],2)):$("",!0)],2)}}},Qe=J(Ge,[["__scopeId","data-v-32d0dd11"]]),ze={class:"modal-header"},Je=["disabled"],We={class:"modal-body"},Ye={class:"form-section"},Ke={class:"category-options"},Ze=["onClick"],et={class:"category-icon"},tt={class:"category-info"},st={class:"category-title"},at={class:"category-description"},ot={class:"category-radio"},lt=["value","id"],nt={key:0,class:"form-section"},it={class:"vote-type-options"},rt=["onClick"],ut={class:"option-header"},ct=["value","id"],vt=["for"],dt={class:"option-description"},pt={key:1,class:"form-section"},mt=["disabled"],ft={class:"avatar-upload"},gt=["disabled"],ht={key:0,class:"file-name"},yt={key:2,class:"form-section"},_t={class:"user-search"},bt=["disabled"],Et={key:0,class:"search-results"},kt=["onClick"],Ct=["src","alt"],$t={class:"user-info"},wt={class:"user-name"},Tt={class:"user-username"},St={key:1,class:"selected-user"},It=["src","alt"],Ut={class:"user-info"},Mt={class:"user-name"},Vt={class:"user-username"},Pt=["disabled"],At={class:"form-label"},Rt=["placeholder","disabled"],Dt={key:3,class:"error-message"},Nt={class:"modal-footer"},xt=["disabled"],Lt=["disabled"],Ot={key:0},Bt={key:1},Ft={__name:"CreateVoteModal",props:{spaceId:{type:Number,required:!0},spaceInfo:{type:Object,required:!1,default:()=>({})}},emits:["vote-created","cancel"],setup(l,{emit:A}){const d=l,U=A;ae();const M=[{value:"space_management",label:"空间管理",description:"修改空间信息、描述或头像",icon:"🏠"},{value:"user_moderation",label:"用户管理",description:"处理违规用户行为",icon:"👥"}],p={space_management:[{value:"UPDATE_SPACE",label:"修改空间信息",description:"更改空间描述或头像"}],user_moderation:[{value:"MUTE_USER",label:"禁言用户",description:"禁止用户在空间中发言"},{value:"EXPEL_USER",label:"驱逐用户",description:"将用户从空间中移除"}]},k=E(""),f=E(""),b=E(!1),C=E(""),_=E({description:"",avatarFile:null}),i=E({searchQuery:"",selectedUser:null,reason:"",searchResults:[],isSearching:!1}),N=x(()=>k.value?p[k.value]||[]:[]),y=x(()=>{if(!f.value||b.value)return!1;switch(f.value){case"UPDATE_SPACE":return _.value.description.trim()||_.value.avatarFile;case"MUTE_USER":case"EXPEL_USER":return i.value.selectedUser&&i.value.reason.trim();default:return!1}});ie(k,()=>{f.value="",C.value=""}),K(()=>{S()});const S=()=>{var t;k.value="",f.value="",C.value="",_.value={description:((t=d.spaceInfo)==null?void 0:t.description)||"",avatarFile:null},i.value={searchQuery:"",selectedUser:null,reason:"",searchResults:[],isSearching:!1}},V=t=>{const c=t.target.files[0];if(c){if(c.size>5*1024*1024){C.value="图片文件大小不能超过5MB";return}if(!c.type.startsWith("image/")){C.value="请选择有效的图片文件";return}_.value.avatarFile=c,C.value=""}},L=async()=>{var c;const t=i.value.searchQuery.trim();if(!t){i.value.searchResults=[];return}try{i.value.isSearching=!0;const r=await H.getSpaceMembers(d.spaceId,t,0,10);r.success&&((c=r.data)!=null&&c.data)?i.value.searchResults=r.data.data:i.value.searchResults=[]}catch(r){console.error("搜索用户失败:",r),i.value.searchResults=[]}finally{i.value.isSearching=!1}},O=t=>{i.value.selectedUser=t,i.value.searchQuery=t.username,i.value.searchResults=[]},F=()=>{i.value.selectedUser=null,i.value.searchQuery="",i.value.searchResults=[]},j=async()=>{var t;if(y.value)try{b.value=!0,C.value="";let c;switch(f.value){case"UPDATE_SPACE":c=await G.createSpaceUpdateVote({spaceId:d.spaceId,description:_.value.description,avatar:_.value.avatarFile,oldAvatar:((t=d.spaceInfo)==null?void 0:t.avatar)||""});break;case"MUTE_USER":c=await G.createMuteUserVote({spaceId:d.spaceId,userId:i.value.selectedUser.userId,username:i.value.selectedUser.username,reason:i.value.reason});break;case"EXPEL_USER":c=await G.createExpelUserVote({spaceId:d.spaceId,userId:i.value.selectedUser.userId,username:i.value.selectedUser.username,reason:i.value.reason});break}c.success?(U("vote-created"),U("cancel")):C.value=c.message||"发起投票失败"}catch(c){console.error("发起投票失败:",c),C.value=c.message||"发起投票失败，请稍后重试"}finally{b.value=!1}},h=()=>{b.value||U("cancel")};return(t,c)=>(s(),a("div",{class:"modal-overlay",onClick:h},[e("div",{class:"modal-content",onClick:c[5]||(c[5]=ue(()=>{},["stop"]))},[e("div",ze,[c[7]||(c[7]=e("h3",null,"发起投票",-1)),e("button",{class:"close-btn",onClick:h,disabled:b.value},c[6]||(c[6]=[e("svg",{width:"24",height:"24",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]),8,Je)]),e("div",We,[e("div",Ye,[c[8]||(c[8]=e("label",{class:"form-label"},"选择投票类别",-1)),e("div",Ke,[(s(),a(B,null,q(M,r=>e("div",{key:r.value,class:P(["category-option",{selected:k.value===r.value}]),onClick:n=>k.value=r.value},[e("div",et,m(r.icon),1),e("div",tt,[e("h4",st,m(r.label),1),e("p",at,m(r.description),1)]),e("div",ot,[z(e("input",{type:"radio",value:r.value,"onUpdate:modelValue":c[0]||(c[0]=n=>k.value=n),id:`category-${r.value}`},null,8,lt),[[oe,k.value]])])],10,Ze)),64))])]),k.value?(s(),a("div",nt,[c[9]||(c[9]=e("label",{class:"form-label"},"选择具体类型",-1)),e("div",it,[(s(!0),a(B,null,q(N.value,r=>(s(),a("div",{key:r.value,class:P(["vote-type-option",{selected:f.value===r.value}]),onClick:n=>f.value=r.value},[e("div",ut,[z(e("input",{type:"radio",value:r.value,"onUpdate:modelValue":c[1]||(c[1]=n=>f.value=n),id:r.value},null,8,ct),[[oe,f.value]]),e("label",{for:r.value,class:"option-title"},m(r.label),9,vt)]),e("p",dt,m(r.description),1)],10,rt))),128))])])):$("",!0),f.value==="UPDATE_SPACE"?(s(),a("div",pt,[c[11]||(c[11]=e("label",{class:"form-label"},"新的空间描述",-1)),z(e("textarea",{"onUpdate:modelValue":c[2]||(c[2]=r=>_.value.description=r),class:"form-textarea",placeholder:"输入新的空间描述...",rows:"4",disabled:b.value},null,8,mt),[[ee,_.value.description]]),c[12]||(c[12]=e("label",{class:"form-label"},"更换头像（可选）",-1)),e("div",ft,[e("input",{type:"file",id:"avatar-upload",accept:"image/*",onChange:V,class:"file-input",disabled:b.value},null,40,gt),c[10]||(c[10]=e("label",{for:"avatar-upload",class:"upload-label"},[e("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 16 16"},[e("path",{d:"M8 0a.5.5 0 0 1 .5.5v7h7a.5.5 0 0 1 0 1h-7v7a.5.5 0 0 1-1 0v-7h-7a.5.5 0 0 1 0-1h7v-7A.5.5 0 0 1 8 0z"})]),Q(" 选择图片 ")],-1)),_.value.avatarFile?(s(),a("span",ht,m(_.value.avatarFile.name),1)):$("",!0)])])):$("",!0),f.value==="MUTE_USER"||f.value==="EXPEL_USER"?(s(),a("div",yt,[c[13]||(c[13]=e("label",{class:"form-label"},"选择用户",-1)),e("div",_t,[z(e("input",{"onUpdate:modelValue":c[3]||(c[3]=r=>i.value.searchQuery=r),onInput:L,type:"text",class:"form-input",placeholder:"搜索用户名...",disabled:b.value},null,40,bt),[[ee,i.value.searchQuery]]),i.value.searchResults.length>0?(s(),a("div",Et,[(s(!0),a(B,null,q(i.value.searchResults,r=>(s(),a("div",{key:r.userId,class:"search-result-item",onClick:n=>O(r)},[e("img",{src:r.avatar,alt:r.nickname,class:"user-avatar"},null,8,Ct),e("div",$t,[e("span",wt,m(r.nickname),1),e("span",Tt,"@"+m(r.username),1)])],8,kt))),128))])):$("",!0),i.value.selectedUser?(s(),a("div",St,[e("img",{src:i.value.selectedUser.avatar,alt:i.value.selectedUser.nickname,class:"user-avatar"},null,8,It),e("div",Ut,[e("span",Mt,m(i.value.selectedUser.nickname),1),e("span",Vt,"@"+m(i.value.selectedUser.username),1)]),e("button",{class:"remove-user-btn",onClick:F,disabled:b.value}," × ",8,Pt)])):$("",!0)]),e("label",At,m(f.value==="MUTE_USER"?"禁言":"驱逐")+"原因",1),z(e("textarea",{"onUpdate:modelValue":c[4]||(c[4]=r=>i.value.reason=r),class:"form-textarea",placeholder:`说明${f.value==="MUTE_USER"?"禁言":"驱逐"}此用户的原因...`,rows:"3",disabled:b.value},null,8,Rt),[[ee,i.value.reason]])])):$("",!0),C.value?(s(),a("div",Dt,m(C.value),1)):$("",!0)]),e("div",Nt,[e("button",{class:"cancel-btn",onClick:h,disabled:b.value}," 取消 ",8,xt),e("button",{class:P(["submit-btn",{loading:b.value}]),onClick:j,disabled:!y.value},[b.value?(s(),a("span",Ot,"提交中...")):(s(),a("span",Bt,"发起投票"))],10,Lt)])])]))}},Ht=J(Ft,[["__scopeId","data-v-0d80d48e"]]),jt={class:"vote-sidebar-container"},Xt={class:"message-content"},qt={key:0,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Gt={key:1,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Qt={class:"sidebar-header"},zt={class:"header-info"},Jt={key:0,class:"stats-compact"},Wt={class:"stat-number"},Yt={class:"stat-label"},Kt=["disabled"],Zt={class:"filter-tabs"},es=["onClick"],ts={key:1,class:"loading-state-compact"},ss={key:2,class:"error-state-compact"},as={class:"error-message-compact"},os={key:0,class:"error-debug-info"},ls={class:"debug-details"},ns={class:"debug-content"},is={key:3,class:"empty-state-compact"},rs={class:"empty-message"},us={key:4,class:"vote-list-compact"},cs={key:0,class:"refreshing-indicator"},vs={__name:"VoteList",props:{spaceId:{type:Number,required:!0},isSidebar:{type:Boolean,default:!0}},setup(l){const A=l,d=E([]),U=E(!1),M=E(!1),p=E(null),k=E(!1),f=E("all"),b=E(""),C=E("");let _=null;const i=(h,t="success")=>{b.value=h,C.value=t,_&&clearTimeout(_),_=setTimeout(()=>{b.value="",C.value=""},3e3)},N=[{value:"all",label:"全部"},{value:"space_management",label:"空间管理"},{value:"user_management",label:"用户管理"}],y=x(()=>{const h=new Date;return d.value.filter(t=>new Date(t.vote.endAt)>h)}),S=x(()=>f.value==="all"?y.value:y.value.filter(h=>{const t=h.vote.voteType;switch(f.value){case"space_management":return t==="UPDATE_SPACE";case"user_management":return["EXPEL_USER","MUTE_USER"].includes(t);default:return!0}})),V=x(()=>({total:y.value.length,filtered:S.value.length})),L=async()=>{try{if(U.value=!0,p.value=null,!A.spaceId||A.spaceId<=0)throw new Error("无效的空间ID");const h=await G.getSpaceVotes(A.spaceId);if(h.success&&h.data)d.value=G.parseSpaceVotes(h.data),d.value.sort((t,c)=>new Date(c.vote.startAt)-new Date(t.vote.startAt));else{const t=h.message||"获取投票数据失败";console.error("VoteList: API返回失败状态",{response:h,message:t}),p.value=t}}catch(h){console.error("VoteList: 获取投票失败",{error:h,message:h.message,status:h.status,spaceId:A.spaceId});let t="网络错误，请稍后重试";h.status===400?t="请求参数错误，请检查空间ID":h.status===401?t="请先登录":h.status===403?t="没有权限查看此空间的投票":h.status===404?t="空间不存在或没有投票":h.status>=500?t="服务器错误，请稍后重试":h.message&&(t=h.message),p.value=t}finally{U.value=!1}},O=h=>{h.success?i(h.message||"投票成功","success"):i(h.message||"投票失败","error")},F=()=>{k.value=!1,M.value=!0,setTimeout(()=>{L().finally(()=>{M.value=!1})},1e3)},j=()=>{L()};return K(()=>{L()}),(h,t)=>{var c;return s(),a("div",jt,[b.value?(s(),a("div",{key:0,class:P(["message-toast",`message-${C.value}`])},[e("div",Xt,[C.value==="success"?(s(),a("svg",qt,t[3]||(t[3]=[e("polyline",{points:"20 6 9 17 4 12"},null,-1)]))):C.value==="error"?(s(),a("svg",Gt,t[4]||(t[4]=[e("circle",{cx:"12",cy:"12",r:"10"},null,-1),e("line",{x1:"15",y1:"9",x2:"9",y2:"15"},null,-1),e("line",{x1:"9",y1:"9",x2:"15",y2:"15"},null,-1)]))):$("",!0),e("span",null,m(b.value),1)])],2)):$("",!0),e("div",Qt,[e("div",zt,[t[5]||(t[5]=e("h4",{class:"sidebar-title"},"空间投票",-1)),V.value.total>0?(s(),a("div",Jt,[e("span",Wt,m(V.value.filtered),1),e("span",Yt,m(f.value==="all"?"进行中":"当前分类"),1)])):$("",!0)]),e("button",{class:"create-vote-btn-compact",onClick:t[0]||(t[0]=r=>k.value=!0),disabled:U.value,title:"发起新投票"},t[6]||(t[6]=[e("svg",{width:"14",height:"14",fill:"currentColor",viewBox:"0 0 16 16"},[e("path",{d:"M8 0a.5.5 0 0 1 .5.5v7h7a.5.5 0 0 1 0 1h-7v7a.5.5 0 0 1-1 0v-7h-7a.5.5 0 0 1 0-1h7v-7A.5.5 0 0 1 8 0z"})],-1)]),8,Kt)]),e("div",Zt,[(s(),a(B,null,q(N,r=>e("button",{key:r.value,class:P(["filter-tab",{active:f.value===r.value}]),onClick:n=>f.value=r.value},m(r.label),11,es)),64))]),U.value?(s(),a("div",ts,t[7]||(t[7]=[e("div",{class:"loading-spinner-small"},null,-1),e("p",null,"加载中...",-1)]))):p.value?(s(),a("div",ss,[t[13]||(t[13]=e("div",{class:"error-icon-small"},"⚠️",-1)),e("p",as,m(p.value),1),p.value.includes("请求参数错误")||p.value.includes("Bad Request")?(s(),a("div",os,[e("details",ls,[t[12]||(t[12]=e("summary",{class:"debug-summary"},"调试信息",-1)),e("div",ns,[e("p",null,[t[8]||(t[8]=e("strong",null,"空间ID:",-1)),Q(" "+m(l.spaceId)+" (类型: "+m(typeof l.spaceId)+")",1)]),e("p",null,[t[9]||(t[9]=e("strong",null,"请求URL:",-1)),Q(" /vote/space?spaceId="+m(l.spaceId),1)]),t[10]||(t[10]=e("p",null,[e("strong",null,"可能原因:")],-1)),t[11]||(t[11]=e("ul",null,[e("li",null,"空间ID无效或不存在"),e("li",null,"没有权限访问此空间的投票"),e("li",null,"后端服务异常")],-1))])])])):$("",!0),e("button",{class:"retry-btn-small",onClick:j},"重试")])):S.value.length===0?(s(),a("div",is,[t[14]||(t[14]=e("div",{class:"empty-icon-small"},"🗳️",-1)),e("p",rs,m(f.value==="all"?"暂无进行中的投票":`暂无${(c=N.find(r=>r.value===f.value))==null?void 0:c.label}相关投票`),1),e("button",{class:"create-first-vote-btn",onClick:t[1]||(t[1]=r=>k.value=!0)},"发起投票")])):(s(),a("div",us,[M.value?(s(),a("div",cs,t[15]||(t[15]=[e("div",{class:"refresh-spinner"},null,-1),e("span",{class:"refresh-text"},"正在同步最新数据...",-1)]))):$("",!0),(s(!0),a(B,null,q(S.value,r=>(s(),Y(Qe,{key:r.vote.id,vote:r,"space-id":l.spaceId,"is-compact":!0,"is-refreshing":M.value,onVoteCast:O},null,8,["vote","space-id","is-refreshing"]))),128))])),k.value?(s(),Y(Ht,{key:5,"space-id":l.spaceId,onCancel:t[2]||(t[2]=r=>k.value=!1),onVoteCreated:F},null,8,["space-id"])):$("",!0)])}}},ds=J(vs,[["__scopeId","data-v-0fa2c97d"]]),ps={class:"space-members-container"},ms={class:"members-header"},fs={key:0,class:"members-count"},gs={key:0,class:"loading-state"},hs={key:1,class:"error-state"},ys={key:2,class:"members-grid"},_s=["title","onClick"],bs=["src","alt"],Es=["title"],ks={class:"more-count"},Cs={key:3,class:"empty-state"},$s={__name:"SpaceMembers",props:{spaceId:{type:Number,required:!0},maxDisplay:{type:Number,default:15}},setup(l){const A=l,d=re(),U=E([]),M=E(!1),p=E(null),k=E(0),f=x(()=>U.value.slice(0,A.maxDisplay)),b=x(()=>{const y=k.value-A.maxDisplay;return y>0?y:0}),C=async()=>{try{M.value=!0,p.value=null;const y=await H.getSpaceMembers(A.spaceId,"",0,A.maxDisplay+5);if(y.success&&y.data)U.value=y.data.data||[],k.value=U.value.length;else throw new Error(y.message||"获取成员列表失败")}catch(y){console.error("获取空间成员失败:",y),p.value=y.message||"加载失败"}finally{M.value=!1}},_=y=>{y.userId&&d.push(`/user/${y.userId}`)},i=y=>y.avatar||"/default-avatar.svg",N=y=>y.nickname||y.username||"未知用户";return K(()=>{C()}),(y,S)=>(s(),a("div",ps,[e("div",ms,[S[0]||(S[0]=ce('<h4 class="members-title" data-v-8e68bb01><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-8e68bb01><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" data-v-8e68bb01></path><circle cx="9" cy="7" r="4" data-v-8e68bb01></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87" data-v-8e68bb01></path><path d="M16 3.13a4 4 0 0 1 0 7.75" data-v-8e68bb01></path></svg> 空间成员 </h4>',1)),k.value>0?(s(),a("div",fs,m(k.value),1)):$("",!0)]),M.value?(s(),a("div",gs,S[1]||(S[1]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"加载中...",-1)]))):p.value?(s(),a("div",hs,[S[2]||(S[2]=e("div",{class:"error-icon"},"⚠️",-1)),e("p",null,m(p.value),1),e("button",{onClick:C,class:"retry-btn"},"重试")])):f.value.length>0?(s(),a("div",ys,[(s(!0),a(B,null,q(f.value,V=>(s(),a("div",{key:V.id,class:"member-avatar",title:N(V),onClick:L=>_(V)},[e("img",{src:i(V),alt:N(V),class:"avatar-image"},null,8,bs)],8,_s))),128)),b.value>0?(s(),a("div",{key:0,class:"more-members",title:`还有 ${b.value} 位成员`},[e("span",ks,"+"+m(b.value),1)],8,Es)):$("",!0)])):(s(),a("div",Cs,S[3]||(S[3]=[e("div",{class:"empty-icon"},"👥",-1),e("p",null,"暂无成员信息",-1)])))]))}},ws=J($s,[["__scopeId","data-v-8e68bb01"]]),Ts={class:"subblock-container"},Ss={key:0,class:"loading-container"},Is={key:1,class:"error-container"},Us={class:"error-actions"},Ms={key:2,class:"not-found-container"},Vs={key:3,class:"subblock-content"},Ps={class:"subblock-header"},As={class:"header-content"},Rs={class:"space-info"},Ds=["src","alt"],Ns={class:"space-details"},xs={class:"space-name"},Ls={class:"space-display-name"},Os={class:"space-description"},Bs={class:"space-stats"},Fs={class:"stat"},Hs={class:"stat"},js={class:"space-actions"},Xs=["disabled"],qs={key:0},Gs={key:1},Qs={key:2},zs={class:"main-content"},Js={class:"posts-container"},Ws={key:0,class:"loading-container"},Ys={key:0,class:"no-posts"},Ks={key:1,class:"posts-list"},Zs={key:0,class:"infinite-loading-indicator"},ea={key:1,class:"end-indicator"},ta={class:"sidebar"},sa={__name:"Subblock",setup(l){const A=ve(),d=re(),U=ae(),M=E(!0),p=E(null),k=E(!1),f=E(null),b=E(!1),C=E(!1),_=E([]),i=E(0),N=E(0),y=E(!1),S=E(!0);let V=null,L=null;const O=x(()=>A.params.spaceId),F=async()=>{try{f.value=null;const u=await le.get(`/post/space?spaceId=${O.value}&page=${i.value}&direction=ASC`);_.value=u.data.data.map(o=>{var g;return{...o,post:{...o.post,spaceId:O.value,spaceName:((g=p.value)==null?void 0:g.name)||"未知空间"}}}),i.value=u.data.currentPage,N.value=u.data.totalPage,S.value=i.value<N.value-1}catch(u){console.error("获取帖子数据失败:",u),f.value=u.message||"加载帖子失败"}},j=async()=>{if(!(y.value||!S.value)){y.value=!0;try{const u=i.value+1,o=await le.get(`/post/space?spaceId=${O.value}&page=${u}&direction=ASC`),g=o.data.data.map(R=>{var T;return{...R,post:{...R.post,spaceId:O.value,spaceName:((T=p.value)==null?void 0:T.name)||"未知空间"}}});_.value=[..._.value,...g],i.value=o.data.currentPage,N.value=o.data.totalPage,S.value=i.value<N.value-1}catch(u){console.error("加载更多帖子失败:",u)}finally{y.value=!1}}},h=()=>{if(y.value||!S.value)return;const u=window.scrollY||document.documentElement.scrollTop,o=window.innerHeight;document.documentElement.scrollHeight-u-o<200&&(L&&clearTimeout(L),L=setTimeout(()=>{j()},100))},t=()=>{V||(V=requestAnimationFrame(()=>{h(),V=null}))},c=(u,o)=>{_.value[u].post=o},r=(u,o)=>{_.value[u].opinion=o},n=(u,o)=>{_.value[u].vote=o},v=async()=>{try{M.value=!0,f.value=null,k.value=!1;const u=parseInt(O.value);if(!u||isNaN(u)){k.value=!0,console.warn(`无效的空间ID: "${O.value}"`);return}const o=await H.getSpaceInfo(u);if(o.success&&o.data){p.value=H.parseSpaceData(o.data),p.value.memberCount===0&&p.value.isMember&&(p.value.memberCount=1),await F();try{await H.getSpaceVotes(u)}catch(g){console.warn("加载空间投票失败:",g)}}else throw new Error(o.message||"获取空间信息失败")}catch(u){console.error("加载空间数据失败:",u),f.value=u.message||"加载失败",k.value=!0,_.value=[]}finally{M.value=!1}},I=async(u,o)=>{try{const g=await H.getSpaceInfo(u);return g.success&&g.data?g.data.isMember===o?!0:(console.warn("状态验证失败，服务器状态与预期不符"),!1):!1}catch(g){return console.warn("验证成员状态失败:",g),!1}},w=async()=>{if(!p.value||!U.isAuthenticated){U.isAuthenticated||d.push("/login");return}try{const u=p.value.isMember,o=p.value.id;if(f.value=null,u){C.value=!0;const g=await H.leaveSpace(o);if(g.success)await new Promise(R=>setTimeout(R,500)),await v();else if(g.message&&g.message.includes("尚未加入"))console.warn("检测到状态不一致：UI显示已加入，但服务器显示未加入"),f.value="检测到状态不一致，正在同步...",await v(),f.value=null;else throw new Error(g.message||"离开空间失败")}else{b.value=!0;const g=await H.joinSpace(o);if(g.success)await new Promise(T=>setTimeout(T,500)),await v(),await I(o,!0)?p.value.memberCount===0&&p.value.isMember&&(p.value.memberCount=1):(console.warn("加入操作可能未完全成功，建议刷新页面"),f.value="加入操作可能未完全成功，如果问题持续存在，请刷新页面");else throw new Error(g.message||"加入空间失败")}}catch(u){console.error("空间操作失败:",u);let o="操作失败，请稍后重试";if(u.message)o=u.message;else if(u.status===401){o="登录已过期，请重新登录",d.push("/login");return}else u.status===403?o="没有权限执行此操作":u.status===404?o="空间不存在":u.status>=500&&(o="服务器错误，请稍后重试");f.value=o;try{await v()}catch(g){console.warn("重新加载空间数据失败:",g)}}finally{b.value=!1,C.value=!1}};return ie(()=>A.params.spaceId,u=>{u&&v()},{immediate:!0}),K(()=>{v(),window.addEventListener("scroll",t,{passive:!0})}),de(()=>{window.removeEventListener("scroll",t),V&&cancelAnimationFrame(V),L&&clearTimeout(L)}),(u,o)=>{var R;const g=pe("router-link");return s(),a("div",Ts,[M.value?(s(),a("div",Ss,o[1]||(o[1]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"正在加载空间信息...",-1)]))):f.value?(s(),a("div",Is,[o[2]||(o[2]=e("h2",null,"操作提示",-1)),e("p",null,m(f.value),1),e("div",Us,[e("button",{onClick:v,class:"retry-btn"},"刷新状态"),e("button",{onClick:o[0]||(o[0]=T=>f.value=null),class:"dismiss-btn"},"关闭提示")])])):k.value?(s(),a("div",Ms,[o[4]||(o[4]=e("h2",null,"空间不存在",-1)),e("p",null,'未找到名为 "'+m(O.value)+'" 的空间',1),W(g,{to:"/",class:"back-home-btn"},{default:te(()=>o[3]||(o[3]=[Q("返回首页")])),_:1})])):p.value?(s(),a("div",Vs,[e("div",Ps,[e("div",{class:"header-background",style:se({backgroundColor:p.value.color})},null,4),e("div",As,[e("div",Rs,[e("img",{src:p.value.avatar||p.value.icon,alt:p.value.displayName,class:"space-avatar"},null,8,Ds),e("div",Ns,[e("h1",xs,"r/"+m(p.value.name),1),e("h2",Ls,m(p.value.displayName),1),e("p",Os,m(p.value.description),1),e("div",Bs,[e("span",Fs,m((R=p.value.memberCount)==null?void 0:R.toLocaleString())+" 成员",1),e("span",Hs,m(p.value.postCount||_.value.length)+" 帖子",1)])])]),e("div",js,[ne(U).isAuthenticated?(s(),a("button",{key:0,onClick:w,disabled:b.value||C.value,class:P(["join-btn",{joined:p.value.isMember,joining:b.value,leaving:C.value}])},[b.value?(s(),a("span",qs,"加入中...")):C.value?(s(),a("span",Gs,"离开中...")):(s(),a("span",Qs,m(p.value.isMember?"已加入":"加入"),1))],10,Xs)):(s(),Y(g,{key:1,to:"/login",class:"login-prompt-btn"},{default:te(()=>o[5]||(o[5]=[Q(" 登录后加入 ")])),_:1}))])])]),e("div",zs,[e("div",Js,[M.value?(s(),a("div",Ws,o[6]||(o[6]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"加载帖子中...",-1)]))):(s(),a(B,{key:1},[_.value.length===0?(s(),a("div",Ys,[o[8]||(o[8]=e("p",null,"这个空间还没有帖子",-1)),W(g,{to:"/submit",class:"create-post-btn"},{default:te(()=>o[7]||(o[7]=[Q("发布第一个帖子")])),_:1})])):(s(),a("div",Ks,[(s(!0),a(B,null,q(_.value,(T,D)=>(s(),Y(me,{key:T.post.id,post:T.post,user:T.user,opinion:T.opinion,vote:T.vote,"onUpdate:post":X=>c(D,X),"onUpdate:opinion":X=>r(D,X),"onUpdate:vote":X=>n(D,X)},null,8,["post","user","opinion","vote","onUpdate:post","onUpdate:opinion","onUpdate:vote"]))),128)),S.value&&y.value?(s(),a("div",Zs,o[9]||(o[9]=[e("div",{class:"loading-spinner small"},null,-1),e("span",null,"加载更多帖子...",-1)]))):$("",!0),!S.value&&_.value.length>0?(s(),a("div",ea,o[10]||(o[10]=[e("span",null,"已经到底了~",-1)]))):$("",!0)]))],64))]),e("div",ta,[W(ws,{"space-id":p.value.id},null,8,["space-id"]),W(ds,{"space-id":p.value.id},null,8,["space-id"])])])])):$("",!0)])}}},na=J(sa,[["__scopeId","data-v-34dd85fd"]]);export{na as default};
