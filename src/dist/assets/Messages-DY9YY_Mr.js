import{_ as T,g as G,c as r,b as l,F as C,i as $,j as p,h as v,t as u,w as k,f as y,z as w,B as P,X as Q,r as h,o as U,a as X,d as e,e as R,p as d,n as I,T as J,G as K,Q as W,R as S,Y as Z}from"./index-CQU0DmQk.js";const ee={class:"message-content"},se={key:0,class:"text-part"},te={__name:"MessageContent",props:{parsedContent:{type:Array,required:!0}},setup(b){return(s,a)=>{const o=G("router-link");return l(),r("div",ee,[(l(!0),r(C,null,$(b.parsedContent,(i,M)=>(l(),r(C,{key:M},[i.type==="text"?(l(),r("span",se,u(i.text),1)):i.type==="user"?(l(),p(o,{key:1,to:i.link,class:"user-link",onClick:a[0]||(a[0]=w(()=>{},["stop"]))},{default:k(()=>[y(u(i.text),1)]),_:2},1032,["to"])):i.type==="space"?(l(),p(o,{key:2,to:i.link,class:"space-link",onClick:a[1]||(a[1]=w(()=>{},["stop"]))},{default:k(()=>[y(u(i.text),1)]),_:2},1032,["to"])):i.type==="post"?(l(),p(o,{key:3,to:i.link,class:"post-link",onClick:a[2]||(a[2]=w(()=>{},["stop"]))},{default:k(()=>[y(u(i.text),1)]),_:2},1032,["to"])):i.type==="comment"?(l(),p(o,{key:4,to:i.link,class:"comment-link",onClick:a[3]||(a[3]=w(()=>{},["stop"]))},{default:k(()=>[y(u(i.text),1)]),_:2},1032,["to"])):v("",!0)],64))),128))])}}},oe=T(te,[["__scopeId","data-v-362c6145"]]),ne={class:"messages-header"},ae={class:"messages-actions"},le=["disabled"],ie=["disabled"],re=["disabled"],ce=["disabled"],de=["disabled"],ue={key:0,class:"loading-container"},he={key:1,class:"error-container"},ve={class:"error-message"},ge={key:2,class:"no-messages"},fe={key:0,class:"unread-indicator"},_e={class:"message-checkbox"},me=["checked","onChange"],ke={class:"message-content"},pe={class:"message-header"},ye={class:"message-title"},we={class:"message-time"},be={class:"message-body"},Me={class:"message-actions"},Ce=["onClick","disabled"],Re=["onClick","disabled"],Te={key:0,class:"infinite-loading-indicator"},xe={key:1,class:"load-more-container"},Le=["disabled"],Ae={key:0},He={key:1},Ie={key:2,class:"end-indicator"},Se={__name:"MessageList",setup(b){P();const s=Q(),a=h(null),o=h(!1),i=h(null),M=h(null),g=h(!1),x=h(!1);let f=null,_=null;const B=t=>{const n=new Date(t);return Math.abs(new Date-n)/36e5<24?W(n,{addSuffix:!0,locale:S}):Z(n,"yyyy年MM月dd日 HH:mm",{locale:S})},L=()=>{i.value?i.value.scrollTo({top:0,behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})},D=async()=>{if(g.value||!s.hasMoreMessages)return;const t=i.value||window,n=t===window?window.pageYOffset:t.scrollTop,c=t===window?document.documentElement.scrollHeight:t.scrollHeight,m=t===window?window.innerHeight:t.clientHeight;c-n-m<200&&(_&&clearTimeout(_),_=setTimeout(async()=>{g.value=!0;try{await s.loadMoreMessages()}catch(q){console.error("无限滚动加载失败:",q)}finally{g.value=!1}},100))},O=()=>{const t=i.value||window,n=t===window?window.pageYOffset:t.scrollTop;x.value=n>300,D()},A=()=>{f||(f=requestAnimationFrame(()=>{O(),f=null}))},H=async()=>{a.value=null;try{await s.refreshMessages(),await K(),L()}catch(t){a.value="刷新失败，请检查网络连接",console.error("刷新消息失败:",t)}},N=async t=>{if(!(o.value||t.isRead)){o.value=!0;try{await s.markAsRead(t.id)}catch(n){a.value="操作失败，请重试",console.error("标记消息已读失败:",n)}finally{o.value=!1}}},V=async()=>{if(!(o.value||!s.selectedMessageIds.length)){o.value=!0;try{await s.markSelectedAsRead()}catch(t){a.value="操作失败，请重试",console.error("批量标记已读失败:",t)}finally{o.value=!1}}},E=async()=>{if(!o.value){o.value=!0;try{await s.markAllAsRead()}catch(t){a.value="操作失败，请重试",console.error("全部标记已读失败:",t)}finally{o.value=!1}}},F=async t=>{if(!o.value&&confirm("确定要删除这条消息吗？")){o.value=!0;try{await s.deleteMessage(t.id)}catch(n){a.value="删除失败，请重试",console.error("删除消息失败:",n)}finally{o.value=!1}}},j=async()=>{if(!(o.value||!s.selectedMessageIds.length)&&confirm(`确定要删除选中的 ${s.selectedMessageIds.length} 条消息吗？`)){o.value=!0;try{await s.deleteSelected()}catch(t){a.value="删除失败，请重试",console.error("批量删除失败:",t)}finally{o.value=!1}}},z=async()=>{if(o.value)return;const t=s.messages.filter(n=>n.isRead).length;if(t===0){alert("没有已读消息可删除");return}if(confirm(`确定要删除所有 ${t} 条已读消息吗？`)){o.value=!0;try{await s.deleteAllRead()}catch(n){a.value="删除失败，请重试",console.error("删除所有已读失败:",n)}finally{o.value=!1}}},Y=async()=>{if(!(s.isLoading||!s.hasMoreMessages))try{await s.loadMoreMessages()}catch(t){a.value="加载更多失败",console.error("加载更多消息失败:",t)}};return U(async()=>{if((i.value||window).addEventListener("scroll",A,{passive:!0}),!s.hasLoadedOnce)try{await s.loadAllMessages()}catch(n){a.value="加载消息失败，请检查网络连接",console.error("初始加载消息失败:",n)}}),X(()=>{(i.value||window).removeEventListener("scroll",A),f&&cancelAnimationFrame(f),_&&clearTimeout(_)}),(t,n)=>(l(),r("div",{class:"messages-container",ref_key:"containerRef",ref:i},[e("div",ne,[n[0]||(n[0]=e("h2",{class:"messages-title"},"消息中心",-1)),e("div",ae,[e("button",{class:"action-btn",disabled:!d(s).selectedMessageIds.length||o.value,onClick:V}," 标记选中为已读 ",8,le),e("button",{class:"action-btn",onClick:E,disabled:o.value}," 全部标记为已读 ",8,ie),e("button",{class:"action-btn danger",disabled:!d(s).selectedMessageIds.length||o.value,onClick:j}," 删除选中 ",8,re),e("button",{class:"action-btn danger",onClick:z,disabled:o.value}," 删除所有已读 ",8,ce),e("button",{class:"action-btn",onClick:H,disabled:d(s).isLoading||o.value}," 刷新 ",8,de)])]),d(s).isLoading&&!d(s).hasLoadedOnce?(l(),r("div",ue,n[1]||(n[1]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"加载消息中...",-1)]))):a.value?(l(),r("div",he,[e("p",ve,u(a.value),1),e("button",{onClick:H,class:"retry-btn"},"重试")])):d(s).messages.length===0&&d(s).hasLoadedOnce?(l(),r("div",ge,n[2]||(n[2]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"}),e("polyline",{points:"22 6 12 13 2 6"})],-1),e("p",null,"暂无消息",-1)]))):(l(),r("div",{key:3,class:"messages-list",ref_key:"messagesListRef",ref:M},[(l(!0),r(C,null,$(d(s).messages,c=>(l(),r("div",{key:c.id,class:I(["message-item",{read:c.isRead,unread:!c.isRead}])},[e("div",{class:I(["message-status",{unread:!c.isRead}])},[c.isRead?v("",!0):(l(),r("div",fe))],2),e("div",_e,[e("input",{type:"checkbox",checked:d(s).selectedMessageIds.includes(c.id),onChange:m=>d(s).toggleMessageSelection(c.id)},null,40,me)]),e("div",ke,[e("div",pe,[e("span",ye,u(c.title),1),e("span",we,u(B(c.createdAt)),1)]),e("div",be,[R(oe,{"parsed-content":c.parsedContent},null,8,["parsed-content"])])]),e("div",Me,[e("button",{class:"message-action-btn",onClick:m=>N(c),disabled:c.isRead||o.value},u(c.isRead?"已读":"标记已读"),9,Ce),e("button",{class:"message-action-btn danger",onClick:m=>F(c),disabled:o.value}," 删除 ",8,Re)])],2))),128)),d(s).hasMoreMessages&&g.value?(l(),r("div",Te,n[3]||(n[3]=[e("div",{class:"loading-spinner small"},null,-1),e("span",null,"加载更多消息...",-1)]))):v("",!0),d(s).hasMoreMessages&&!g.value?(l(),r("div",xe,[e("button",{onClick:Y,disabled:d(s).isLoading,class:"load-more-btn"},[d(s).isLoading?(l(),r("span",Ae,"加载中...")):(l(),r("span",He,"加载更多"))],8,Le)])):v("",!0),!d(s).hasMoreMessages&&d(s).messages.length>0?(l(),r("div",Ie,n[4]||(n[4]=[e("span",null,"已经到底了~",-1)]))):v("",!0)],512)),R(J,{name:"back-to-top"},{default:k(()=>[x.value?(l(),r("button",{key:0,class:"back-to-top-btn",onClick:L,"aria-label":"返回顶部"},n[5]||(n[5]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"m18 15-6-6-6 6"})],-1)]))):v("",!0)]),_:1})],512))}},$e=T(Se,[["__scopeId","data-v-73332005"]]),Be={class:"messages-page"},De={class:"container"},Oe={__name:"Messages",setup(b){return document.title="消息中心 | Postopia",(s,a)=>(l(),r("div",Be,[a[0]||(a[0]=e("div",{class:"page-header"},[e("div",{class:"container"},[e("h1",null,"消息中心"),e("p",{class:"page-description"}," 查看和管理您的所有消息，支持批量操作 ")])],-1)),e("div",De,[R($e)])]))}},Fe=T(Oe,[["__scopeId","data-v-bdb02e9b"]]);export{Fe as default};
