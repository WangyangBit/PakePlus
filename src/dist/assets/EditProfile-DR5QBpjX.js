import{_ as q,u as F,r as d,Z as M,l as G,o as J,c,b as v,d as e,h as B,t as r,f as w,s as k,y as V,$ as L,e as H,w as W,p as Z,g as K,B as O}from"./index-CQU0DmQk.js";import{u as p}from"./userService-DpfDZGAf.js";const Q={class:"edit-profile-page"},X={class:"edit-container"},Y={key:0,class:"loading-container"},ee={key:1,class:"error-container"},te={key:2,class:"edit-sections"},se={class:"edit-section"},ae={class:"avatar-section"},oe={class:"current-avatar"},ie=["src","alt"],ne={class:"avatar-actions"},le=["disabled"],re={class:"edit-section"},ue={class:"form-group"},de=["value"],ce={class:"form-group"},ve={class:"help-text"},me={class:"form-group"},pe={class:"help-text"},fe=["disabled"],we={key:0},he={key:1},ge={class:"edit-section"},ye={class:"form-group"},ke={class:"email-display"},_e={class:"email-text"},be={class:"email-visibility"},Ee={class:"checkbox-label"},xe=["disabled"],Ce={class:"form-group"},Ve={class:"email-change-section"},Se=["disabled"],De=["disabled"],Me={key:0,class:"verification-section"},Be=["disabled"],Pe={class:"edit-section"},Te={class:"stats-grid"},Ue={class:"stat-item"},Ie={class:"stat-value"},Ae={class:"stat-item"},Ne={class:"stat-value"},$e={class:"stat-item"},Re={class:"stat-value"},je={class:"stat-item"},ze={class:"stat-value"},qe={class:"action-buttons"},Fe={key:0,class:"success-toast"},Ge={key:1,class:"error-toast"},Je={__name:"EditProfile",setup(Le){const U=O(),P=F(),h=d(!1),S=d(!0),_=d(!1),b=d(!1),g=d(!1),E=d(!1),D=d(!1),f=d(null),x=d(""),C=d(""),a=d({}),i=M({nickname:"",introduction:""}),m=M({showEmail:!1}),o=M({newEmail:"",verificationCode:"",verificationSent:!1}),I=G(()=>s=>s?new Date(s).toLocaleDateString("zh-CN"):"--"),A=async()=>{try{if(!P.isAuthenticated){U.push("/login");return}const s=await p.getUserDetail();if(s.success&&s.data)a.value=s.data,i.nickname=a.value.nickname||a.value.username||"",i.introduction=a.value.introduction||"",m.showEmail=a.value.showEmail||!1,f.value=null;else throw new Error(s.message||"获取用户信息失败")}catch(s){console.error("加载真实用户数据失败:",s),f.value=s.message||"加载用户信息失败，请刷新页面重试",a.value={}}},T=async()=>{try{S.value=!0,f.value=null,await A()}catch(s){console.error("初始化用户数据失败:",s),f.value=s.message||"加载失败"}finally{S.value=!1}},N=async s=>{const t=s.target.files[0];if(t){if(!t.type.startsWith("image/")){u("请选择图片文件");return}if(t.size>5*1024*1024){u("图片文件大小不能超过 5MB");return}try{if(_.value=!0,h.value){await new Promise(n=>setTimeout(n,1500));const l=`https://i.pravatar.cc/150?img=${Math.floor(Math.random()*50)+1}`;a.value.avatar=l}else{const l=await p.updateAvatar(t);if(l.success&&l.data)a.value.avatar=l.data.avatar;else throw new Error(l.message||"头像上传失败")}y("头像更新成功")}catch(l){console.error("头像上传失败:",l),u("头像上传失败，请重试")}finally{_.value=!1,s.target.value=""}}},$=async()=>{try{if(b.value=!0,h.value)await new Promise(s=>setTimeout(s,800)),a.value.nickname=i.nickname,a.value.introduction=i.introduction;else{const s=[];if(i.nickname!==a.value.nickname&&s.push(p.updateNickname(i.nickname)),i.introduction!==a.value.introduction&&s.push(p.updateIntroduction(i.introduction)),s.length>0){const l=(await Promise.all(s)).filter(n=>!n.success);if(l.length>0)throw new Error(l[0].message||"更新基本信息失败");a.value.nickname=i.nickname,a.value.introduction=i.introduction}}y("基本信息更新成功")}catch(s){console.error("更新基本信息失败:",s),u("基本信息更新失败")}finally{b.value=!1}},R=async()=>{try{if(D.value=!0,h.value)await new Promise(s=>setTimeout(s,500)),a.value.showEmail=m.showEmail;else{const s=await p.updateEmailVisibility(m.showEmail);if(s.success)a.value.showEmail=m.showEmail;else throw new Error(s.message||"更新邮箱显示设置失败")}y("邮箱显示设置已更新")}catch(s){console.error("更新邮箱显示设置失败:",s),m.showEmail=!m.showEmail,u("邮箱显示设置更新失败")}finally{D.value=!1}},j=async()=>{if(!o.newEmail){u("请输入新的邮箱地址");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o.newEmail)){u("邮箱地址格式不正确");return}try{if(g.value=!0,h.value)await new Promise(t=>setTimeout(t,1e3)),o.verificationSent=!0;else{const t=await p.requestEmailChange(o.newEmail);if(t.success)o.verificationSent=!0;else throw new Error(t.message||"发送验证码失败")}y("验证码已发送到新邮箱，请查收")}catch(t){console.error("请求邮箱修改失败:",t),u("发送验证码失败，请重试")}finally{g.value=!1}},z=async()=>{if(!o.verificationCode){u("请输入验证码");return}if(!/^\d{6}$/.test(o.verificationCode)){u("请输入6位数字验证码");return}try{if(E.value=!0,h.value)await new Promise(s=>setTimeout(s,800)),a.value.email=o.newEmail;else{const s=await p.verifyEmailChange(o.newEmail,o.verificationCode);if(s.success)a.value.email=o.newEmail;else throw new Error(s.message||"邮箱验证失败")}o.newEmail="",o.verificationCode="",o.verificationSent=!1,y("邮箱修改成功")}catch(s){console.error("邮箱验证失败:",s),u("邮箱验证失败，请重试")}finally{E.value=!1}},y=s=>{x.value=s,setTimeout(()=>{x.value=""},3e3)},u=s=>{C.value=s,setTimeout(()=>{C.value=""},5e3)};return J(()=>{T()}),(s,t)=>{const l=K("router-link");return v(),c("div",Q,[e("div",X,[t[28]||(t[28]=e("div",{class:"page-header"},[e("h1",null,"编辑个人资料"),e("p",null,"更新您的个人信息和偏好设置")],-1)),S.value?(v(),c("div",Y,t[6]||(t[6]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"加载中...",-1)]))):f.value?(v(),c("div",ee,[t[7]||(t[7]=e("h2",null,"加载失败",-1)),e("p",null,r(f.value),1),e("button",{onClick:T,class:"retry-btn"},"重试")])):(v(),c("div",te,[e("section",se,[t[10]||(t[10]=e("h2",null,"头像",-1)),e("div",ae,[e("div",oe,[e("img",{src:a.value.avatar||"/default-avatar.png",alt:a.value.username,class:"avatar-image"},null,8,ie)]),e("div",ne,[e("input",{ref:"avatarInput",type:"file",accept:"image/*",onChange:N,style:{display:"none"}},null,544),e("button",{onClick:t[0]||(t[0]=n=>s.$refs.avatarInput.click()),class:"upload-btn",disabled:_.value},[t[8]||(t[8]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"}),e("path",{d:"m16 2 4 4-10 10-4 1 1-4L18 2"})],-1)),w(" "+r(_.value?"上传中...":"更换头像"),1)],8,le),t[9]||(t[9]=e("p",{class:"help-text"},"支持 JPG、PNG 格式，文件大小不超过 5MB",-1))])])]),e("section",re,[t[16]||(t[16]=e("h2",null,"基本信息",-1)),e("div",ue,[t[11]||(t[11]=e("label",null,"用户名",-1)),e("input",{type:"text",value:a.value.username,readonly:"",class:"form-input readonly"},null,8,de),t[12]||(t[12]=e("p",{class:"help-text"},"用户名无法修改",-1))]),e("div",ce,[t[13]||(t[13]=e("label",{for:"nickname"},"昵称",-1)),k(e("input",{id:"nickname","onUpdate:modelValue":t[1]||(t[1]=n=>i.nickname=n),type:"text",class:"form-input",placeholder:"输入您的昵称",maxlength:"30"},null,512),[[V,i.nickname]]),e("p",ve,r(i.nickname.length)+"/30 字符",1)]),e("div",me,[t[14]||(t[14]=e("label",{for:"introduction"},"个人简介",-1)),k(e("textarea",{id:"introduction","onUpdate:modelValue":t[2]||(t[2]=n=>i.introduction=n),class:"form-textarea",placeholder:"介绍一下您自己...",rows:"4",maxlength:"200"},null,512),[[V,i.introduction]]),e("p",pe,r(i.introduction.length)+"/200 字符",1)]),e("button",{onClick:$,class:"save-btn",disabled:b.value},[b.value?(v(),c("span",we,t[15]||(t[15]=[e("div",{class:"loading-spinner small"},null,-1),w(" 保存中... ")]))):(v(),c("span",he,"保存基本信息"))],8,fe)]),e("section",ge,[t[21]||(t[21]=e("h2",null,"邮箱设置",-1)),e("div",ye,[t[19]||(t[19]=e("label",null,"当前邮箱",-1)),e("div",ke,[e("span",_e,r(a.value.email||"未设置邮箱"),1),e("div",be,[e("label",Ee,[k(e("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=n=>m.showEmail=n),onChange:R,disabled:D.value},null,40,xe),[[L,m.showEmail]]),t[17]||(t[17]=e("span",{class:"checkmark"},null,-1)),t[18]||(t[18]=w(" 公开显示邮箱 "))])])])]),e("div",Ce,[t[20]||(t[20]=e("label",{for:"newEmail"},"新邮箱地址",-1)),e("div",Ve,[k(e("input",{id:"newEmail","onUpdate:modelValue":t[4]||(t[4]=n=>o.newEmail=n),type:"email",class:"form-input",placeholder:"输入新的邮箱地址",disabled:g.value},null,8,Se),[[V,o.newEmail]]),e("button",{onClick:j,class:"verify-btn",disabled:!o.newEmail||g.value},r(g.value?"发送中...":"发送验证码"),9,De)]),o.verificationSent?(v(),c("div",Me,[k(e("input",{"onUpdate:modelValue":t[5]||(t[5]=n=>o.verificationCode=n),type:"text",class:"form-input",placeholder:"输入验证码",maxlength:"6"},null,512),[[V,o.verificationCode]]),e("button",{onClick:z,class:"save-btn",disabled:!o.verificationCode||E.value},r(E.value?"验证中...":"确认修改"),9,Be)])):B("",!0)])]),e("section",Pe,[t[26]||(t[26]=e("h2",null,"账户统计",-1)),e("div",Te,[e("div",Ue,[e("div",Ie,r(a.value.postCount||0),1),t[22]||(t[22]=e("div",{class:"stat-label"},"发帖数",-1))]),e("div",Ae,[e("div",Ne,r(a.value.commentCount||0),1),t[23]||(t[23]=e("div",{class:"stat-label"},"评论数",-1))]),e("div",$e,[e("div",Re,r(a.value.credit||0),1),t[24]||(t[24]=e("div",{class:"stat-label"},"积分",-1))]),e("div",je,[e("div",ze,r(I.value(a.value.createdAt)),1),t[25]||(t[25]=e("div",{class:"stat-label"},"加入日期",-1))])])])])),e("div",qe,[H(l,{to:`/user/${Z(P).userId}`,class:"cancel-btn"},{default:W(()=>t[27]||(t[27]=[w(" 返回资料页 ")])),_:1},8,["to"])])]),x.value?(v(),c("div",Fe,[t[29]||(t[29]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("polyline",{points:"20 6 9 17 4 12"})],-1)),w(" "+r(x.value),1)])):B("",!0),C.value?(v(),c("div",Ge,[t[30]||(t[30]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("circle",{cx:"12",cy:"12",r:"10"}),e("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),e("line",{x1:"9",y1:"9",x2:"15",y2:"15"})],-1)),w(" "+r(C.value),1)])):B("",!0)])}}},Ke=q(Je,[["__scopeId","data-v-1045e2de"]]);export{Ke as default};
