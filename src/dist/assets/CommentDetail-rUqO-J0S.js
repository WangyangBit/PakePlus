import{_ as he,u as we,r as a,l as m,D as ge,q as ke,o as ye,a as Ie,c,b as l,h as w,d as s,n as T,t as v,j as G,N as _e,e as S,w as U,f as D,g as Ce,p as X,H as be,L as Se,Q as Ve,R as xe,v as M,S as Ee,M as Pe,B as Te}from"./index-CQU0DmQk.js";import{P as De,C as Ae}from"./PostVoteWidget-awAzXFsy.js";import{T as Ne}from"./TrendingSubblocks-dkyX5rXB.js";const je={class:"comment-detail-layout"},Be={class:"message-content"},Le={key:0,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Re={key:1,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},Oe={class:"main-content"},Ge={key:0,class:"loading-container"},Ue={key:2,class:"error-container"},Me={key:3,class:"comment-detail"},We={class:"vote-container"},He={class:"vote-score"},$e={class:"post-detail-content"},qe={class:"post-header"},ze={class:"post-metadata"},Fe={class:"post-time"},Qe={key:0,class:"post-archived-badge"},Je={class:"post-title-section"},Ke={class:"post-title"},Xe=["disabled"],Ye={key:0,class:"vote-dropdown-menu"},Ze=["disabled"],et=["disabled"],tt={key:0,class:"post-body"},st=["innerHTML"],ot={class:"post-actions"},nt={class:"post-action"},at={key:0,class:"comment-section"},lt={class:"comments-list"},it={class:"sidebar"},ut={key:0,class:"subblock-info-card"},rt={class:"subblock-stats"},ct={class:"stat"},vt={class:"stat-value"},dt={class:"stat"},pt={class:"stat-value"},mt={class:"stat"},ft={class:"stat-value"},ht={class:"community-buttons"},wt={__name:"CommentDetail",setup(gt){const V=ge();Te();const _=we(),C=a(!0),g=a(null),x=a(!1),Y=a(!1),W=a(null);a(!1);const y=a(!1),A=a(null),d=a(!1),N=a(null),E=a(""),b=a("");let j=null;const i=(t,e="success")=>{E.value=t,b.value=e,j&&clearTimeout(j),j=setTimeout(()=>{E.value="",b.value=""},3e3)},B=m(()=>V.params.postId),k=m(()=>V.params.spaceId),Z=m(()=>V.params.commentId),p=a(null),o=a(null),P=a([]);a(null);const ee=async()=>{try{let t=0,e=1;for(;t<e;){const n=await Se({page:t.toString()});if(n&&n.success){const{data:u,totalPage:r}=n.data;P.value=[...P.value,...u],e=r,t++}else throw new Error((n==null?void 0:n.message)||"获取空间数据失败")}}catch{}},L=m(()=>{const t=k.value;if(t&&P.value.length>0){const e=P.value.find(n=>n.id==t);if(e)return e.name}return"未知社区"}),te=async()=>{var t,e;C.value=!0,g.value=null;try{const n=await Ee(Z.value);n&&n.success?p.value=n.data:(x.value=!0,g.value="找不到此评论")}catch(n){g.value=n.message||"获取评论时发生错误",n.status===404||(t=n.message)!=null&&t.includes("找不到")||(e=n.message)!=null&&e.includes("不存在")?(x.value=!0,g.value="找不到此评论"):g.value=n.message||"获取评论时发生错误"}finally{C.value=!1}},H=async()=>{try{const t=await Pe(B.value);t&&t.success&&(o.value=t.data)}catch{}},R=async()=>{C.value=!0,g.value=null;try{await Promise.all([te(),H()])}finally{C.value=!1}};m(()=>{var t,e;return(e=(t=p.value)==null?void 0:t.comment)!=null&&e.comment?p.value.comment.comment.positiveCount-p.value.comment.comment.negativeCount:0});const se=m(()=>{var t;return(t=o.value)!=null&&t.post?o.value.post.positiveCount-o.value.post.negativeCount:0});m(()=>{var t,e,n,u,r,f;return((n=(e=(t=p.value)==null?void 0:t.comment)==null?void 0:e.opinion)==null?void 0:n.opinionStatus)!=="NIL"&&((f=(r=(u=p.value)==null?void 0:u.comment)==null?void 0:r.opinion)==null?void 0:f.opinionStatus)!==void 0}),m(()=>{var t,e,n;return{voted:((n=(e=(t=p.value)==null?void 0:t.comment)==null?void 0:e.opinion)==null?void 0:n.opinionStatus)==="POSITIVE",upvote:!0}}),m(()=>{var t,e,n;return{voted:((n=(e=(t=p.value)==null?void 0:t.comment)==null?void 0:e.opinion)==null?void 0:n.opinionStatus)==="NEGATIVE",downvote:!0}});const oe=m(()=>{var t,e;return{voted:((e=(t=o.value)==null?void 0:t.opinion)==null?void 0:e.opinionStatus)==="POSITIVE",upvote:!0}}),ne=m(()=>{var t,e;return{voted:((e=(t=o.value)==null?void 0:t.opinion)==null?void 0:e.opinionStatus)==="NEGATIVE",downvote:!0}}),ae=async()=>{var t;if(o.value)try{const e=((t=o.value.opinion)==null?void 0:t.opinionStatus)==="POSITIVE"?"NIL":"POSITIVE";{o.value.opinion||(o.value.opinion={});const n=o.value.opinion.opinionStatus;o.value.opinion.opinionStatus=e,n==="NEGATIVE"?(o.value.post.negativeCount-=1,e==="POSITIVE"&&(o.value.post.positiveCount+=1)):n==="POSITIVE"?o.value.post.positiveCount-=1:e==="POSITIVE"&&(o.value.post.positiveCount+=1)}}catch{}},le=async()=>{var t;if(o.value)try{const e=((t=o.value.opinion)==null?void 0:t.opinionStatus)==="NEGATIVE"?"NIL":"NEGATIVE";{o.value.opinion||(o.value.opinion={});const n=o.value.opinion.opinionStatus;o.value.opinion.opinionStatus=e,n==="POSITIVE"?(o.value.post.positiveCount-=1,e==="NEGATIVE"&&(o.value.post.negativeCount+=1)):n==="NEGATIVE"?o.value.post.negativeCount-=1:e==="NEGATIVE"&&(o.value.post.negativeCount+=1)}}catch{}},$=t=>{if(!t)return"N/A";try{const e=new Date(t);return Ve(e,{addSuffix:!0,locale:xe})}catch{return"N/A"}},q=t=>{W.value&&!W.value.contains(t.target)&&(Y.value=!1),A.value&&!A.value.contains(t.target)&&(y.value=!1)},ie=()=>{y.value=!y.value},I=a(null),ue=m(()=>{var t,e;return(e=(t=o.value)==null?void 0:t.post)!=null&&e.isArchived?"取消归档":"归档帖子"}),re=async()=>{var t;if(!(!((t=o.value)!=null&&t.post)||d.value))try{d.value=!0,y.value=!1;const e=o.value.post.id,n=o.value.post.spaceId||k.value,u=_.userId,r=o.value.post.subject,f={postId:e,spaceId:n,postSubject:r,userId:u},h=await M.createArchivePostVote(f);h.success?(i("归档帖子投票已发起","success"),I.value&&await I.value.refreshVotes()):i(h.message||"归档投票发起失败","error")}catch{i("归档投票发起失败，请稍后重试","error")}finally{d.value=!1}},ce=async()=>{var t;if(!(!((t=o.value)!=null&&t.post)||d.value))try{d.value=!0,y.value=!1;const e=o.value.post.id,n=o.value.post.spaceId||k.value,u=_.userId,r=o.value.post.subject,f={postId:e,spaceId:n,postSubject:r,userId:u},h=await M.createUnarchivePostVote(f);h.success?(i("取消归档帖子投票已发起","success"),I.value&&await I.value.refreshVotes()):i(h.message||"取消归档投票发起失败","error")}catch{i("取消归档投票发起失败，请稍后重试","error")}finally{d.value=!1}},ve=async()=>{var t;if(!(!((t=o.value)!=null&&t.post)||d.value))try{d.value=!0,y.value=!1;const e=o.value.post.id,n=o.value.post.spaceId||k.value,u=_.userId,r=o.value.post.subject,f={postId:e,spaceId:n,postSubject:r,userId:u},h=await M.createDeletePostVote(f);h.success?(i("删除帖子投票已发起","success"),I.value&&await I.value.refreshVotes()):i(h.message||"删除投票发起失败","error")}catch{i("删除投票发起失败，请稍后重试","error")}finally{d.value=!1}},de=t=>{t.success?i(t.message||"投票成功","success"):i(t.message||"投票失败","error")},pe=t=>{i("投票操作成功","success"),N.value&&N.value.refreshVotes()},me=t=>{t.success?i(t.message||"投票成功","success"):i(t.message||"投票失败","error")},fe=async()=>{await H(),i("投票数据已刷新","success")};return ke(()=>V.params.commentId,t=>{t&&R()}),ye(async()=>{await ee(),await R(),document.addEventListener("click",q)}),Ie(()=>{document.removeEventListener("click",q)}),(t,e)=>{var u,r,f,h,z,F,Q,J;const n=Ce("router-link");return l(),c("div",je,[E.value?(l(),c("div",{key:0,class:T(["message-toast",`message-${b.value}`])},[s("div",Be,[b.value==="success"?(l(),c("svg",Le,e[1]||(e[1]=[s("polyline",{points:"20 6 9 17 4 12"},null,-1)]))):b.value==="error"?(l(),c("svg",Re,e[2]||(e[2]=[s("circle",{cx:"12",cy:"12",r:"10"},null,-1),s("line",{x1:"15",y1:"9",x2:"9",y2:"15"},null,-1),s("line",{x1:"9",y1:"9",x2:"15",y2:"15"},null,-1)]))):w("",!0),s("span",null,v(E.value),1)])],2)):w("",!0),s("div",Oe,[C.value?(l(),c("div",Ge,e[3]||(e[3]=[s("div",{class:"loading-spinner"},null,-1),s("p",null,"加载内容中...",-1)]))):x.value?(l(),G(_e,{key:1,message:"评论未找到",description:"抱歉，我们无法找到您请求的评论。它可能已被删除或从未存在。"})):g.value&&!x.value?(l(),c("div",Ue,[e[4]||(e[4]=s("div",{class:"error-icon"},"⚠️",-1)),s("p",null,v(g.value),1),s("button",{onClick:R,class:"retry-button"},"重试")])):(u=p.value)!=null&&u.comment&&((r=o.value)!=null&&r.post)?(l(),c("div",Me,[s("div",{class:T(["post-detail-card",{archived:o.value.post.isArchived}])},[s("div",We,[s("button",{class:T(oe.value),onClick:ae,"aria-label":"Upvote Post"},e[5]||(e[5]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[s("polyline",{points:"18 15 12 9 6 15"})],-1)]),2),s("div",He,v(se.value),1),s("button",{class:T(ne.value),onClick:le,"aria-label":"Downvote Post"},e[6]||(e[6]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[s("polyline",{points:"6 9 12 15 18 9"})],-1)]),2)]),s("div",$e,[s("div",qe,[S(n,{to:`/r/${L.value}`,class:"subblock-link"},{default:U(()=>[D(" r/"+v(L.value),1)]),_:1},8,["to"]),s("span",ze,[e[7]||(e[7]=D(" 发布者 ")),S(n,{to:`/user/${((f=o.value.user)==null?void 0:f.userId)||"unknown"}`,class:"author-link"},{default:U(()=>{var O,K;return[D(" u/"+v(((O=o.value.user)==null?void 0:O.username)||((K=o.value.user)==null?void 0:K.nickname)||"unknown"),1)]}),_:1},8,["to"]),s("span",Fe,v($(o.value.post.createdAt)),1)]),o.value.post.isArchived?(l(),c("div",Qe,e[8]||(e[8]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[s("polyline",{points:"21,8 21,21 3,21 3,8"}),s("rect",{x:"1",y:"3",width:"22",height:"5"}),s("line",{x1:"10",y1:"12",x2:"14",y2:"12"})],-1),s("span",null,"已归档",-1)]))):w("",!0)]),s("div",Je,[s("h1",Ke,v(o.value.post.subject),1),X(_).isAuthenticated?(l(),c("div",{key:0,class:"post-vote-dropdown",ref_key:"postDropdownRef",ref:A},[s("button",{onClick:ie,class:"vote-dropdown-button",disabled:d.value},e[9]||(e[9]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[s("circle",{cx:"12",cy:"12",r:"1"}),s("circle",{cx:"19",cy:"12",r:"1"}),s("circle",{cx:"5",cy:"12",r:"1"})],-1)]),8,Xe),y.value?(l(),c("div",Ye,[s("button",{onClick:e[0]||(e[0]=O=>o.value.post.isArchived?ce():re()),class:"vote-dropdown-item",disabled:d.value},[e[10]||(e[10]=s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[s("polyline",{points:"21 8 12 17 3 8"})],-1)),s("span",null,v(ue.value),1)],8,Ze),s("button",{onClick:ve,class:"vote-dropdown-item delete-item",disabled:d.value},e[11]||(e[11]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[s("polyline",{points:"3 6 5 6 21 6"}),s("path",{d:"m19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})],-1),s("span",null,"删除帖子",-1)]),8,et)])):w("",!0)],512)):w("",!0)]),o.value.post.content?(l(),c("div",tt,[s("div",{innerHTML:o.value.post.content,class:"rich-content"},null,8,st)])):w("",!0),s("div",ot,[s("div",nt,[e[12]||(e[12]=s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[s("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})],-1)),s("span",null,v(o.value.post.commentCount)+" 个评论",1)])])])],2),(h=p.value)!=null&&h.comment?(l(),c("div",at,[e[13]||(e[13]=s("h3",{class:"comments-header"},"评论与回复",-1)),s("div",lt,[S(be,{comment:p.value,"post-id":B.value,"space-id":k.value,"is-reply-active":!1,"is-submitting":!1,"active-reply":null,"show-detail-link":!1,onVoteSuccess:pe},null,8,["comment","post-id","space-id"])])])):w("",!0)])):w("",!0)]),s("div",it,[(z=o.value)!=null&&z.post?(l(),c("div",ut,[s("h3",null,"About r/"+v(L.value),1),s("div",rt,[s("div",ct,[s("div",vt,v(o.value.post.positiveCount.toLocaleString()),1),e[14]||(e[14]=s("div",{class:"stat-label"},"点赞",-1))]),s("div",dt,[s("div",pt,v(o.value.post.commentCount.toLocaleString()),1),e[15]||(e[15]=s("div",{class:"stat-label"},"评论",-1))]),s("div",mt,[s("div",ft,v($(o.value.post.createdAt)),1),e[16]||(e[16]=s("div",{class:"stat-label"},"发布时间",-1))])]),s("div",ht,[S(n,{to:`/r/${k.value}`,class:"view-community-btn"},{default:U(()=>e[17]||(e[17]=[D(" 查看该社区 ")])),_:1},8,["to"])])])):w("",!0),S(Ne),(F=o.value)!=null&&F.post&&X(_).isAuthenticated?(l(),G(De,{key:1,"space-id":k.value,"post-vote-data":(Q=o.value)==null?void 0:Q.vote,"show-current-post-only":!0,onVoteCast:me,onRefreshRequested:fe,style:{"margin-top":"var(--space-4)"},ref_key:"postVoteWidgetRef",ref:I},null,8,["space-id","post-vote-data"])):w("",!0),(J=p.value)!=null&&J.comment?(l(),G(Ae,{key:2,"post-id":B.value,"space-id":k.value,onVoteCast:de,style:{"margin-top":"var(--space-4)"},ref_key:"commentVoteWidgetRef",ref:N},null,8,["post-id","space-id"])):w("",!0)])])}}},_t=he(wt,[["__scopeId","data-v-ba603c11"]]);export{_t as default};
